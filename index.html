<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chess Arena</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:linear-gradient(135deg,#1a1814 0%,#2d2926 50%,#1a1814 100%);color:#fff;font-family:'Segoe UI',system-ui,sans-serif;min-height:100vh;overflow-x:hidden}

/* NAV */
.navbar{background:linear-gradient(180deg,#272522 0%,#1f1d1a 100%);height:52px;display:flex;align-items:center;padding:0 24px;border-bottom:1px solid #3d3a36;position:fixed;top:0;left:0;right:0;z-index:100;box-shadow:0 2px 12px rgba(0,0,0,.4)}
.logo{font-size:24px;font-weight:800;margin-right:32px;cursor:pointer;display:flex;align-items:center;gap:8px}
.logo-icon{font-size:28px;filter:drop-shadow(0 2px 4px rgba(129,182,76,.4))}
.logo span{background:linear-gradient(135deg,#81b64c,#a4d65e);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.nav-links{display:flex;gap:6px}
.nav-btn{background:none;border:none;color:#888;font-size:14px;padding:10px 20px;cursor:pointer;border-radius:6px;font-weight:600;transition:all .2s;display:flex;align-items:center;gap:6px}
.nav-btn:hover{background:rgba(255,255,255,.08);color:#ccc}
.nav-btn.active{background:linear-gradient(135deg,#81b64c22,#81b64c11);color:#81b64c;box-shadow:inset 0 -2px 0 #81b64c}

/* MAIN */
.main-wrap{display:flex;justify-content:center;align-items:flex-start;gap:16px;padding:72px 24px 32px;min-height:100vh}

/* PLAYER CARD */
.player-card{display:flex;align-items:center;gap:12px;padding:10px 14px;background:linear-gradient(135deg,#2a2825,#232120);border-radius:8px;margin:6px 0;border:1px solid #3a3733;transition:all .3s}
.player-card.active-turn{border-color:#81b64c;box-shadow:0 0 20px rgba(129,182,76,.2)}
.player-avatar{width:38px;height:38px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,.3)}
.avatar-white{background:linear-gradient(135deg,#81b64c,#6a9a3d);color:#fff}
.avatar-black{background:linear-gradient(135deg,#555,#333);color:#fff}
.player-info{flex:1;min-width:0}
.player-name{font-size:15px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.player-rating{color:#888;font-size:12px;margin-top:1px}
.captured-pieces{display:flex;flex-wrap:wrap;gap:1px;margin-left:8px;max-width:120px}
.captured-pieces img{width:18px;height:18px;opacity:.85}
.material-diff{font-size:12px;color:#81b64c;font-weight:700;margin-left:4px}
.clock{margin-left:auto;background:#1a1816;color:#aaa;padding:8px 16px;border-radius:6px;font-family:'JetBrains Mono','Courier New',monospace;font-size:22px;font-weight:700;min-width:90px;text-align:center;border:2px solid transparent;transition:all .3s}
.clock.ticking{background:linear-gradient(135deg,#81b64c,#6a9a3d);color:#fff;border-color:#a4d65e;animation:pulse 1s infinite}
.clock.danger{background:linear-gradient(135deg,#ca3431,#a62c29);animation:pulse .5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.85}}

/* BOARD */
.board-section{display:flex;flex-direction:column}
.board-wrapper{position:relative;border-radius:6px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,.5),0 0 0 4px #1a1816}
#board{width:600px;height:600px;background-image:url('https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/board.png');background-size:cover;position:relative;cursor:default}
.square{position:absolute;width:75px;height:75px;display:flex;align-items:center;justify-content:center}
.square img{width:90%;height:90%;pointer-events:none;filter:drop-shadow(2px 3px 3px rgba(0,0,0,.4));transition:transform .1s,filter .15s}
.square:hover img{filter:drop-shadow(2px 3px 6px rgba(0,0,0,.6))}
.square.can-move{cursor:grab}
.square.can-move:active{cursor:grabbing}

/* Dragging */
.dragging{position:fixed;pointer-events:none;z-index:1000;width:85px;height:85px;filter:drop-shadow(4px 8px 12px rgba(0,0,0,.5));transform:translate(-50%,-50%) scale(1.15);transition:none}

/* Square states */
.square.selected{background:rgba(255,255,90,.5)!important;box-shadow:inset 0 0 0 3px rgba(255,255,90,.7)}
.square.last-from,.square.last-to{background:rgba(255,255,90,.35)!important}
.square.legal-dot::after{content:'';position:absolute;width:22px;height:22px;background:radial-gradient(circle,rgba(0,0,0,.18) 0%,rgba(0,0,0,.12) 100%);border-radius:50%;pointer-events:none}
.square.legal-capture::after{content:'';position:absolute;width:68px;height:68px;border:5px solid rgba(0,0,0,.15);border-radius:50%;pointer-events:none}
.square.check{background:radial-gradient(ellipse at center,rgba(255,50,50,.85) 0%,rgba(200,40,40,.5) 35%,transparent 70%)!important;animation:checkPulse 1s infinite}
@keyframes checkPulse{0%,100%{box-shadow:inset 0 0 20px rgba(255,0,0,.3)}50%{box-shadow:inset 0 0 30px rgba(255,0,0,.5)}}
.square.hint-best{background:rgba(129,182,76,.45)!important}
.square.premove{background:rgba(100,150,200,.4)!important}

/* Review highlights */
.square.rv-brilliant{background:linear-gradient(135deg,rgba(26,188,188,.6),rgba(26,188,188,.4))!important;box-shadow:inset 0 0 15px rgba(26,188,188,.5)}
.square.rv-great{background:linear-gradient(135deg,rgba(92,172,238,.55),rgba(92,172,238,.35))!important}
.square.rv-best{background:linear-gradient(135deg,rgba(150,188,75,.55),rgba(150,188,75,.35))!important}
.square.rv-excellent{background:rgba(150,188,75,.4)!important}
.square.rv-good{background:rgba(129,182,76,.35)!important}
.square.rv-book{background:rgba(168,139,195,.4)!important}
.square.rv-inaccuracy{background:linear-gradient(135deg,rgba(240,196,90,.5),rgba(240,196,90,.3))!important}
.square.rv-mistake{background:linear-gradient(135deg,rgba(232,166,58,.55),rgba(232,166,58,.35))!important}
.square.rv-blunder{background:linear-gradient(135deg,rgba(202,52,49,.6),rgba(202,52,49,.4))!important;animation:blunderPulse 1.5s infinite}
@keyframes blunderPulse{0%,100%{box-shadow:inset 0 0 10px rgba(202,52,49,.4)}50%{box-shadow:inset 0 0 20px rgba(202,52,49,.6)}}

/* Coords */
.coord{position:absolute;font-size:11px;font-weight:700;pointer-events:none;z-index:2;opacity:.75;font-family:'JetBrains Mono',monospace}
.coord.file{bottom:2px;right:4px}
.coord.rank{top:3px;left:4px}
.sq-light .coord{color:#779556}
.sq-dark .coord{color:#ebecd0}

/* Move arrow (for showing best move in review) */
.move-arrow{position:absolute;pointer-events:none;z-index:10;opacity:.8}

/* EVAL BAR */
.eval-wrap{width:32px;height:600px;background:#333;border-radius:6px;overflow:hidden;position:relative;flex-shrink:0;box-shadow:0 4px 12px rgba(0,0,0,.4)}
.eval-fill{position:absolute;bottom:0;width:100%;background:linear-gradient(180deg,#f8f8f8,#e0e0e0);transition:height .6s cubic-bezier(.4,0,.2,1)}
.eval-label{position:absolute;width:100%;text-align:center;font-size:10px;font-weight:800;z-index:5;font-family:'JetBrains Mono',monospace}
.eval-top{top:4px;color:#bbb}
.eval-bot{bottom:4px;color:#444}

/* RIGHT PANEL */
.right-panel{width:360px;display:flex;flex-direction:column;gap:10px}
.card{background:linear-gradient(135deg,#272522,#1f1d1a);border-radius:10px;border:1px solid #3a3733;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.3)}
.card-header{padding:14px 16px;font-size:14px;font-weight:700;border-bottom:1px solid #3a3733;display:flex;align-items:center;gap:10px;background:rgba(0,0,0,.15)}
.card-header .icon{font-size:18px}

/* Move list */
.move-list{padding:8px;max-height:340px;overflow-y:auto;min-height:120px}
.move-list::-webkit-scrollbar{width:6px}
.move-list::-webkit-scrollbar-track{background:#1a1816}
.move-list::-webkit-scrollbar-thumb{background:#555;border-radius:3px}
.move-list::-webkit-scrollbar-thumb:hover{background:#777}
.move-row{display:flex;align-items:stretch;margin-bottom:2px}
.move-num{color:#666;font-size:12px;width:32px;text-align:center;padding:6px 0;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-family:'JetBrains Mono',monospace}
.move-cell{flex:1;padding:6px 10px;cursor:pointer;font-size:14px;border-radius:4px;display:flex;align-items:center;gap:5px;font-weight:600;transition:all .15s}
.move-cell:hover{background:rgba(255,255,255,.08)}
.move-cell.active{background:linear-gradient(135deg,#4a4a3a,#3a3a2a);box-shadow:inset 0 0 0 1px rgba(255,255,255,.1)}
.move-cell .m-icon{width:18px;height:18px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;flex-shrink:0}
.m-icon.brilliant{background:linear-gradient(135deg,#1abcbc,#15a3a3);color:#fff;box-shadow:0 2px 8px rgba(26,188,188,.4)}
.m-icon.great{background:linear-gradient(135deg,#5caced,#4a9ad8);color:#fff}
.m-icon.best{background:linear-gradient(135deg,#96bc4b,#7da33d);color:#fff}
.m-icon.excellent{background:#81b64c;color:#fff}
.m-icon.good{background:#6a9a3d;color:#fff}
.m-icon.book{background:linear-gradient(135deg,#a88bc3,#9477ae);color:#fff}
.m-icon.inaccuracy{background:linear-gradient(135deg,#f0c45a,#ddb347);color:#333}
.m-icon.mistake{background:linear-gradient(135deg,#e8a63a,#d4912f);color:#fff}
.m-icon.blunder{background:linear-gradient(135deg,#ca3431,#b02b28);color:#fff;box-shadow:0 2px 8px rgba(202,52,49,.4)}
.m-icon.forced{background:#666;color:#fff}

/* Status */
.status-bar{padding:12px 16px;font-size:14px;font-weight:600;text-align:center;border-top:1px solid #3a3733;background:rgba(0,0,0,.1)}
.status-bar.win{color:#81b64c}
.status-bar.lose{color:#ca3431}
.status-bar.draw{color:#f0c45a}
.status-bar .turn-indicator{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle}
.turn-indicator.white{background:#f0f0f0;box-shadow:0 0 6px rgba(255,255,255,.5)}
.turn-indicator.black{background:#333;border:1px solid #555}

/* Controls */
.controls{display:flex;gap:6px;padding:10px;justify-content:center;border-top:1px solid #3a3733}
.ctrl-btn{background:linear-gradient(135deg,#3a3733,#2d2a27);border:1px solid #4a4743;color:#ccc;padding:10px 18px;cursor:pointer;border-radius:6px;font-size:16px;transition:all .15s;display:flex;align-items:center;justify-content:center}
.ctrl-btn:hover{background:linear-gradient(135deg,#4a4743,#3d3a37);color:#fff;transform:translateY(-1px)}
.ctrl-btn:active{transform:translateY(0)}
.ctrl-btn:disabled{opacity:.3;cursor:not-allowed;transform:none}

/* Setup */
.setup-wrap{padding:24px}
.setup-wrap h3{margin-bottom:20px;font-size:18px;display:flex;align-items:center;gap:10px}
.setup-wrap h3 .icon{font-size:24px}
.setup-group{margin-bottom:18px}
.setup-group label{display:block;font-size:12px;color:#888;margin-bottom:6px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.setup-group select{width:100%;padding:12px 14px;background:linear-gradient(135deg,#1a1816,#232120);border:1px solid #3a3733;color:#fff;border-radius:8px;font-size:14px;cursor:pointer;transition:all .15s}
.setup-group select:hover{border-color:#555}
.setup-group select:focus{outline:none;border-color:#81b64c;box-shadow:0 0 0 3px rgba(129,182,76,.2)}
.btn-play{width:100%;padding:16px;background:linear-gradient(135deg,#81b64c,#6a9a3d);color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer;transition:all .2s;text-transform:uppercase;letter-spacing:1px;box-shadow:0 4px 15px rgba(129,182,76,.3)}
.btn-play:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(129,182,76,.4)}
.btn-play:active{transform:translateY(0)}
.btn-secondary{width:100%;padding:14px;background:linear-gradient(135deg,#4a90d9,#3a7bc8);color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:700;cursor:pointer;margin-top:10px;box-shadow:0 4px 15px rgba(74,144,217,.3)}
.btn-secondary:hover{transform:translateY(-1px)}
.btn-danger{width:100%;padding:12px;background:linear-gradient(135deg,#ca3431,#a62c29);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;margin-top:10px}
.btn-danger:hover{opacity:.9}

/* Review Summary */
.review-summary{padding:20px}
.accuracy-row{display:flex;justify-content:center;gap:40px;margin:20px 0}
.acc-item{text-align:center}
.acc-ring{width:72px;height:72px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:800;margin:0 auto 8px;position:relative}
.acc-ring::before{content:'';position:absolute;inset:-3px;border-radius:50%;background:conic-gradient(var(--acc-color) calc(var(--acc-pct)*3.6deg),#3a3733 0);z-index:-1}
.acc-ring::after{content:'';position:absolute;inset:3px;border-radius:50%;background:#272522;z-index:-1}
.acc-ring.white-ring{--acc-color:#f0f0f0;color:#f0f0f0}
.acc-ring.black-ring{--acc-color:#888;color:#ccc}
.acc-label{font-size:12px;color:#888;font-weight:600}

.class-grid{display:grid;grid-template-columns:1fr auto auto;gap:4px 16px;font-size:13px;padding:0 8px}
.class-row{display:contents}
.class-row .lbl{display:flex;align-items:center;gap:8px;padding:4px 0}
.class-row .dot{width:14px;height:14px;border-radius:50%;flex-shrink:0}
.class-row .cnt{text-align:center;color:#aaa;font-weight:600;padding:4px 8px}

/* Move Detail */
.move-detail{padding:14px 16px;border-top:1px solid #3a3733;min-height:70px;background:rgba(0,0,0,.1)}
.md-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.md-header .m-icon{width:24px;height:24px;font-size:12px}
.md-class-name{font-weight:700;font-size:15px}
.md-eval{color:#888;font-size:12px;font-family:'JetBrains Mono',monospace}
.md-suggestion{margin-top:8px;padding:8px 10px;background:rgba(129,182,76,.1);border-radius:6px;font-size:12px;color:#81b64c;border-left:3px solid #81b64c}

/* Opening */
.opening-bar{text-align:center;font-size:12px;color:#888;padding:6px;background:rgba(0,0,0,.2);border-radius:0 0 6px 6px;margin-top:-1px}

/* Modals */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:200;justify-content:center;align-items:center}
.modal.show{display:flex}
.modal-content{background:linear-gradient(135deg,#2a2825,#1f1d1a);border-radius:16px;border:1px solid #3a3733;box-shadow:0 20px 60px rgba(0,0,0,.5);overflow:hidden;animation:modalIn .3s}
@keyframes modalIn{from{opacity:0;transform:scale(.9) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}

.promo-box{padding:16px;display:flex;gap:8px}
.promo-box button{width:80px;height:80px;background:linear-gradient(135deg,#3a3733,#2d2a27);border:2px solid transparent;border-radius:10px;cursor:pointer;padding:8px;transition:all .15s}
.promo-box button:hover{border-color:#81b64c;transform:scale(1.05);box-shadow:0 8px 25px rgba(0,0,0,.3)}
.promo-box button img{width:100%;height:100%}

.gameover-content{padding:36px;text-align:center;min-width:340px}
.gameover-content h2{font-size:28px;margin-bottom:10px}
.gameover-content .result-icon{font-size:48px;margin-bottom:12px}
.gameover-content p{color:#888;margin-bottom:24px;font-size:15px}
.gameover-btns{display:flex;gap:10px;justify-content:center}
.gameover-btns button{padding:14px 28px;border:none;border-radius:8px;font-size:15px;font-weight:700;cursor:pointer;transition:all .15s}
.gameover-btns button:hover{transform:translateY(-2px)}

/* Spinner */
.spinner-wrap{text-align:center;padding:48px 24px}
.spinner{width:48px;height:48px;border:4px solid #3a3733;border-top-color:#81b64c;border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 20px}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner-wrap p{color:#ccc;font-size:15px}
.spinner-wrap .sub{color:#666;font-size:13px;margin-top:8px}

/* Sound toggle */
.sound-toggle{position:fixed;bottom:20px;right:20px;background:rgba(39,37,34,.9);border:1px solid #3a3733;border-radius:8px;padding:10px 14px;cursor:pointer;font-size:20px;z-index:50;transition:all .15s}
.sound-toggle:hover{background:#3a3733}

/* Responsive */
@media(max-width:1100px){
  .main-wrap{flex-direction:column;align-items:center;padding-top:64px}
  #board{width:min(90vw,500px);height:min(90vw,500px)}
  .square{width:calc(100%/8)!important;height:calc(100%/8)!important}
  .eval-wrap{width:min(90vw,500px);height:24px;flex-direction:row}
  .eval-fill{height:100%!important;width:50%;left:0;bottom:auto;transition:width .6s}
  .right-panel{width:min(90vw,500px)}
}
</style>
</head>
<body>

<nav class="navbar">
  <div class="logo"><span class="logo-icon">‚ôü</span> Chess<span>Arena</span></div>
  <div class="nav-links">
    <button class="nav-btn active" id="tabPlay" onclick="switchTab('play')">‚ñ∂ Play</button>
    <button class="nav-btn" id="tabReview" onclick="switchTab('review')">üìä Review</button>
  </div>
</nav>

<div class="main-wrap">
  <div class="eval-wrap" id="evalWrap" style="display:none">
    <div class="eval-label eval-top" id="evalTop"></div>
    <div class="eval-fill" id="evalFill"></div>
    <div class="eval-label eval-bot" id="evalBot"></div>
  </div>

  <div class="board-section">
    <div class="player-card" id="topCard">
      <div class="player-avatar avatar-black" id="topAvatar">AI</div>
      <div class="player-info"><div class="player-name" id="topName">Computer</div><div class="player-rating" id="topRating">Depth 3</div></div>
      <div class="captured-pieces" id="topCaptured"></div>
      <span class="material-diff" id="topMaterial"></span>
      <div class="clock" id="topClock">10:00</div>
    </div>
    <div class="board-wrapper">
      <div id="board"></div>
    </div>
    <div class="player-card" id="botCard">
      <div class="player-avatar avatar-white" id="botAvatar">You</div>
      <div class="player-info"><div class="player-name" id="botName">You</div><div class="player-rating" id="botRating">Player</div></div>
      <div class="captured-pieces" id="botCaptured"></div>
      <span class="material-diff" id="botMaterial"></span>
      <div class="clock" id="botClock">10:00</div>
    </div>
    <div class="opening-bar" id="openingBar"></div>
  </div>

  <div class="right-panel" id="panel"></div>
</div>

<div class="modal" id="promoModal"><div class="modal-content"><div class="promo-box" id="promoBox"></div></div></div>
<div class="modal" id="gameoverModal">
  <div class="modal-content gameover-content">
    <div class="result-icon" id="goIcon">üéâ</div>
    <h2 id="goTitle">Game Over</h2>
    <p id="goMsg"></p>
    <div class="gameover-btns">
      <button style="background:linear-gradient(135deg,#81b64c,#6a9a3d);color:#fff" onclick="newGame()">üîÑ New Game</button>
      <button style="background:linear-gradient(135deg,#4a90d9,#3a7bc8);color:#fff" onclick="startReview()">üìä Review</button>
    </div>
  </div>
</div>

<div class="sound-toggle" id="soundToggle" onclick="toggleSound()">üîä</div>

<script>
// ======================== ASSETS ========================
const IMG='https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/';
const PIECE_IMG={
  K:IMG+'whiteking.png',Q:IMG+'whitequeen.png',R:IMG+'whiterook.png',
  B:IMG+'whitebishop.png',N:IMG+'whiteknight.png',P:IMG+'whitepawn.png',
  k:IMG+'blackking.png',q:IMG+'blackqueen.png',r:IMG+'blackrook.png',
  b:IMG+'blackbishop.png',n:IMG+'blackknight.png',p:IMG+'blackpawn.png'
};
const PIECE_VAL={p:1,n:3,b:3,r:5,q:9,k:0,P:1,N:3,B:3,R:5,Q:9,K:0};

// ======================== SOUNDS ========================
let soundOn=true;
const sounds={
  move:()=>playTone(200,.08),
  capture:()=>playTone(150,.12),
  check:()=>{playTone(400,.1);setTimeout(()=>playTone(500,.1),100)},
  castle:()=>{playTone(200,.06);setTimeout(()=>playTone(250,.06),80)},
  promote:()=>{playTone(300,.08);setTimeout(()=>playTone(400,.08),80);setTimeout(()=>playTone(500,.08),160)},
  gameEnd:()=>{playTone(300,.15);setTimeout(()=>playTone(400,.15),150);setTimeout(()=>playTone(500,.2),300)},
  illegal:()=>playTone(100,.15)
};
let audioCtx;
function playTone(freq,dur){
  if(!soundOn)return;
  if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.connect(g);g.connect(audioCtx.destination);
  o.frequency.value=freq;o.type='sine';
  g.gain.setValueAtTime(.15,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(.01,audioCtx.currentTime+dur);
  o.start();o.stop(audioCtx.currentTime+dur);
}
function toggleSound(){soundOn=!soundOn;document.getElementById('soundToggle').textContent=soundOn?'üîä':'üîá'}

// ======================== CHESS ENGINE ========================
class Chess{
  constructor(){this.reset()}
  reset(){
    this.board=this._initBoard();this.turn='w';
    this.castling={K:1,Q:1,k:1,q:1};this.ep=null;
    this.halfMoves=0;this.fullMoves=1;
    this.history=[];this.fens=[this.fen()];
    this.over=false;this.result=null;this.reason='';
  }
  _initBoard(){return[
    ['r','n','b','q','k','b','n','r'],
    ['p','p','p','p','p','p','p','p'],
    [,,,,,,,],[,,,,,,,],[,,,,,,,],[,,,,,,,],
    ['P','P','P','P','P','P','P','P'],
    ['R','N','B','Q','K','B','N','R']
  ]}
  clone(){
    const c=new Chess();c.board=this.board.map(r=>[...r]);c.turn=this.turn;
    c.castling={...this.castling};c.ep=this.ep?[...this.ep]:null;
    c.halfMoves=this.halfMoves;c.fullMoves=this.fullMoves;
    c.over=this.over;c.result=this.result;c.reason=this.reason;
    c.history=[...this.history];c.fens=[...this.fens];return c;
  }
  color(p){return p?(p===p.toUpperCase()?'w':'b'):null}
  type(p){return p?p.toLowerCase():null}
  inBounds(r,c){return r>=0&&r<8&&c>=0&&c<8}
  findKing(col){const k=col==='w'?'K':'k';for(let r=0;r<8;r++)for(let c=0;c<8;c++)if(this.board[r][c]===k)return[r,c];return null}
  
  isAttacked(r,c,by){
    const kMoves=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];
    const kn=by==='w'?'N':'n';
    for(const[dr,dc]of kMoves){const nr=r+dr,nc=c+dc;if(this.inBounds(nr,nc)&&this.board[nr][nc]===kn)return true}
    const ki=by==='w'?'K':'k';
    for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){if(!dr&&!dc)continue;const nr=r+dr,nc=c+dc;if(this.inBounds(nr,nc)&&this.board[nr][nc]===ki)return true}
    const pd=by==='w'?1:-1,pw=by==='w'?'P':'p';
    for(const dc of[-1,1]){const nr=r+pd,nc=c+dc;if(this.inBounds(nr,nc)&&this.board[nr][nc]===pw)return true}
    const rq=by==='w'?['R','Q']:['r','q'];
    for(const[dr,dc]of[[0,1],[0,-1],[1,0],[-1,0]])for(let i=1;i<8;i++){const nr=r+dr*i,nc=c+dc*i;if(!this.inBounds(nr,nc))break;const p=this.board[nr][nc];if(p){if(rq.includes(p))return true;break}}
    const bq=by==='w'?['B','Q']:['b','q'];
    for(const[dr,dc]of[[1,1],[1,-1],[-1,1],[-1,-1]])for(let i=1;i<8;i++){const nr=r+dr*i,nc=c+dc*i;if(!this.inBounds(nr,nc))break;const p=this.board[nr][nc];if(p){if(bq.includes(p))return true;break}}
    return false;
  }
  inCheck(col){const kp=this.findKing(col);if(!kp)return false;return this.isAttacked(kp[0],kp[1],col==='w'?'b':'w')}
  
  pseudoMoves(col){
    const moves=[];
    for(let r=0;r<8;r++)for(let c=0;c<8;c++){
      const p=this.board[r][c];if(!p||this.color(p)!==col)continue;
      const t=this.type(p);
      if(t==='p'){
        const dir=col==='w'?-1:1,sr=col==='w'?6:1,pr=col==='w'?0:7;
        let nr=r+dir;
        if(this.inBounds(nr,c)&&!this.board[nr][c]){
          if(nr===pr)for(const q of['q','r','b','n'])moves.push({f:[r,c],t:[nr,c],pr:q});
          else{moves.push({f:[r,c],t:[nr,c]});if(r===sr&&!this.board[r+2*dir][c])moves.push({f:[r,c],t:[r+2*dir,c]})}
        }
        for(const dc of[-1,1]){const nc=c+dc;if(!this.inBounds(nr,nc))continue;
          const tgt=this.board[nr][nc];
          if(tgt&&this.color(tgt)!==col){if(nr===pr)for(const q of['q','r','b','n'])moves.push({f:[r,c],t:[nr,nc],pr:q});else moves.push({f:[r,c],t:[nr,nc]})}
          if(this.ep&&nr===this.ep[0]&&nc===this.ep[1])moves.push({f:[r,c],t:[nr,nc],ep:1})
        }
      }else if(t==='n'){
        for(const[dr,dc]of[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]]){const nr=r+dr,nc=c+dc;if(this.inBounds(nr,nc)){const x=this.board[nr][nc];if(!x||this.color(x)!==col)moves.push({f:[r,c],t:[nr,nc]})}}
      }else if(t==='k'){
        for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){if(!dr&&!dc)continue;const nr=r+dr,nc=c+dc;if(this.inBounds(nr,nc)){const x=this.board[nr][nc];if(!x||this.color(x)!==col)moves.push({f:[r,c],t:[nr,nc]})}}
        const opp=col==='w'?'b':'w';
        if(col==='w'){
          if(this.castling.K&&!this.board[7][5]&&!this.board[7][6]&&this.board[7][7]==='R'&&!this.isAttacked(7,4,opp)&&!this.isAttacked(7,5,opp)&&!this.isAttacked(7,6,opp))moves.push({f:[7,4],t:[7,6],cs:'K'});
          if(this.castling.Q&&!this.board[7][3]&&!this.board[7][2]&&!this.board[7][1]&&this.board[7][0]==='R'&&!this.isAttacked(7,4,opp)&&!this.isAttacked(7,3,opp)&&!this.isAttacked(7,2,opp))moves.push({f:[7,4],t:[7,2],cs:'Q'});
        }else{
          if(this.castling.k&&!this.board[0][5]&&!this.board[0][6]&&this.board[0][7]==='r'&&!this.isAttacked(0,4,opp)&&!this.isAttacked(0,5,opp)&&!this.isAttacked(0,6,opp))moves.push({f:[0,4],t:[0,6],cs:'k'});
          if(this.castling.q&&!this.board[0][3]&&!this.board[0][2]&&!this.board[0][1]&&this.board[0][0]==='r'&&!this.isAttacked(0,4,opp)&&!this.isAttacked(0,3,opp)&&!this.isAttacked(0,2,opp))moves.push({f:[0,4],t:[0,2],cs:'q'});
        }
      }else{
        const dirs=[];
        if(t==='r'||t==='q')dirs.push([0,1],[0,-1],[1,0],[-1,0]);
        if(t==='b'||t==='q')dirs.push([1,1],[1,-1],[-1,1],[-1,-1]);
        for(const[dr,dc]of dirs)for(let i=1;i<8;i++){const nr=r+dr*i,nc=c+dc*i;if(!this.inBounds(nr,nc))break;const x=this.board[nr][nc];if(!x)moves.push({f:[r,c],t:[nr,nc]});else{if(this.color(x)!==col)moves.push({f:[r,c],t:[nr,nc]});break}}
      }
    }
    return moves;
  }
  
  legalMoves(col){
    col=col||this.turn;
    return this.pseudoMoves(col).filter(m=>{const c=this.clone();c.applyMove(m);return!c.inCheck(col)});
  }
  
  applyMove(m){
    const[fr,fc]=m.f,[tr,tc]=m.t;
    const piece=this.board[fr][fc];
    if(m.ep){const cr=this.turn==='w'?tr+1:tr-1;this.board[cr][tc]=null}
    this.board[tr][tc]=piece;this.board[fr][fc]=null;
    if(m.pr)this.board[tr][tc]=this.color(piece)==='w'?m.pr.toUpperCase():m.pr;
    if(m.cs==='K'){this.board[7][5]='R';this.board[7][7]=null}
    if(m.cs==='Q'){this.board[7][3]='R';this.board[7][0]=null}
    if(m.cs==='k'){this.board[0][5]='r';this.board[0][7]=null}
    if(m.cs==='q'){this.board[0][3]='r';this.board[0][0]=null}
    if(piece==='K'){this.castling.K=0;this.castling.Q=0}
    if(piece==='k'){this.castling.k=0;this.castling.q=0}
    if(fr===7&&fc===7)this.castling.K=0;if(fr===7&&fc===0)this.castling.Q=0;
    if(fr===0&&fc===7)this.castling.k=0;if(fr===0&&fc===0)this.castling.q=0;
    if(tr===7&&tc===7)this.castling.K=0;if(tr===7&&tc===0)this.castling.Q=0;
    if(tr===0&&tc===7)this.castling.k=0;if(tr===0&&tc===0)this.castling.q=0;
    this.ep=this.type(piece)==='p'&&Math.abs(fr-tr)===2?[(fr+tr)/2,fc]:null;
    if(this.type(piece)==='p'||this.board[tr][tc])this.halfMoves=0;else this.halfMoves++;
    if(this.turn==='b')this.fullMoves++;
    this.turn=this.turn==='w'?'b':'w';
  }
  
  toSAN(m){
    const[fr,fc]=m.f,[tr,tc]=m.t;const p=this.board[fr][fc];const t=this.type(p);const files='abcdefgh';const cap=this.board[tr][tc]||m.ep;
    if(m.cs==='K'||m.cs==='k')return'O-O';if(m.cs==='Q'||m.cs==='q')return'O-O-O';
    let s='';
    if(t==='p'){if(cap)s+=files[fc]+'x';s+=files[tc]+(8-tr);if(m.pr)s+='='+m.pr.toUpperCase()}
    else{s=t.toUpperCase();
      const others=this.pseudoMoves(this.color(p)).filter(om=>this.board[om.f[0]][om.f[1]]===p&&om.t[0]===tr&&om.t[1]===tc&&!(om.f[0]===fr&&om.f[1]===fc));
      if(others.length){const sf=others.some(om=>om.f[1]===fc),sr=others.some(om=>om.f[0]===fr);if(!sf)s+=files[fc];else if(!sr)s+=(8-fr);else s+=files[fc]+(8-fr)}
      if(cap)s+='x';s+=files[tc]+(8-tr);
    }
    return s;
  }
  
  makeMove(m){
    const san=this.toSAN(m);
    let captured=this.board[m.t[0]][m.t[1]];
    if(m.ep){const cr=this.turn==='w'?m.t[0]+1:m.t[0]-1;captured=this.board[cr][m.t[1]]}
    const wasCheck=this.inCheck(this.turn==='w'?'b':'w');
    this.applyMove(m);
    const legal=this.legalMoves();
    const isCheck=this.inCheck(this.turn);
    let sanFinal=san+(isCheck?(legal.length===0?'#':'+'):'');
    m.san=sanFinal;m.cap=captured;m.isCheck=isCheck;m.isMate=isCheck&&legal.length===0;m.cs=m.cs;
    this.history.push(m);this.fens.push(this.fen());
    this.checkEnd();
    return{san:sanFinal,captured,isCheck,isMate:m.isMate,castle:m.cs,promo:m.pr};
  }
  
  checkEnd(){
    const legal=this.legalMoves();
    if(!legal.length){this.over=true;
      if(this.inCheck(this.turn)){this.result=this.turn==='w'?'0-1':'1-0';this.reason='checkmate'}
      else{this.result='1/2-1/2';this.reason='stalemate'}
      return;
    }
    if(this.halfMoves>=100){this.over=true;this.result='1/2-1/2';this.reason='50-move rule';return}
    if(this.insufficientMaterial()){this.over=true;this.result='1/2-1/2';this.reason='insufficient material';return}
    const cf=this.fen().split(' ').slice(0,4).join(' ');
    if(this.fens.filter(f=>f.split(' ').slice(0,4).join(' ')===cf).length>=3){this.over=true;this.result='1/2-1/2';this.reason='threefold repetition'}
  }
  
  insufficientMaterial(){
    const pcs=[];for(let r=0;r<8;r++)for(let c=0;c<8;c++)if(this.board[r][c])pcs.push(this.board[r][c]);
    if(pcs.length===2)return true;
    if(pcs.length===3){const ts=pcs.map(p=>p.toLowerCase());if(ts.includes('b')||ts.includes('n'))return true}
    return false;
  }
  
  fen(){
    let f='';
    for(let r=0;r<8;r++){let e=0;for(let c=0;c<8;c++){if(this.board[r][c]){if(e){f+=e;e=0}f+=this.board[r][c]}else e++}if(e)f+=e;if(r<7)f+='/'}
    f+=' '+this.turn+' ';
    let cs='';if(this.castling.K)cs+='K';if(this.castling.Q)cs+='Q';if(this.castling.k)cs+='k';if(this.castling.q)cs+='q';
    f+=cs||'-';f+=' ';
    f+=this.ep?'abcdefgh'[this.ep[1]]+(8-this.ep[0]):'-';
    f+=' '+this.halfMoves+' '+this.fullMoves;return f;
  }
}

// ======================== AI ========================
class AI{
  constructor(depth=3){
    this.depth=depth;
    this.pieceVal={p:100,n:320,b:330,r:500,q:900,k:20000};
    this.pst={
      p:[[0,0,0,0,0,0,0,0],[50,50,50,50,50,50,50,50],[10,10,20,30,30,20,10,10],[5,5,10,27,27,10,5,5],[0,0,0,25,25,0,0,0],[5,-5,-10,0,0,-10,-5,5],[5,10,10,-25,-25,10,10,5],[0,0,0,0,0,0,0,0]],
      n:[[-50,-40,-30,-30,-30,-30,-40,-50],[-40,-20,0,0,0,0,-20,-40],[-30,0,10,15,15,10,0,-30],[-30,5,15,20,20,15,5,-30],[-30,0,15,20,20,15,0,-30],[-30,5,10,15,15,10,5,-30],[-40,-20,0,5,5,0,-20,-40],[-50,-40,-30,-30,-30,-30,-40,-50]],
      b:[[-20,-10,-10,-10,-10,-10,-10,-20],[-10,0,0,0,0,0,0,-10],[-10,0,10,10,10,10,0,-10],[-10,5,5,10,10,5,5,-10],[-10,0,10,10,10,10,0,-10],[-10,10,10,10,10,10,10,-10],[-10,5,0,0,0,0,5,-10],[-20,-10,-10,-10,-10,-10,-10,-20]],
      r:[[0,0,0,0,0,0,0,0],[5,10,10,10,10,10,10,5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[0,0,0,5,5,0,0,0]],
      q:[[-20,-10,-10,-5,-5,-10,-10,-20],[-10,0,0,0,0,0,0,-10],[-10,0,5,5,5,5,0,-10],[-5,0,5,5,5,5,0,-5],[0,0,5,5,5,5,0,-5],[-10,5,5,5,5,5,0,-10],[-10,0,5,0,0,0,0,-10],[-20,-10,-10,-5,-5,-10,-10,-20]],
      k:[[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-20,-30,-30,-40,-40,-30,-30,-20],[-10,-20,-20,-20,-20,-20,-20,-10],[20,20,0,0,0,0,20,20],[20,30,10,0,0,10,30,20]]
    };
  }
  evaluate(g){
    let score=0;
    for(let r=0;r<8;r++)for(let c=0;c<8;c++){
      const p=g.board[r][c];if(!p)continue;const t=p.toLowerCase();
      const val=this.pieceVal[t]||0;const pstVal=this.pst[t]?this.pst[t][r][c]:0;
      if(p===p.toUpperCase())score+=val+pstVal;
      else score-=val+(this.pst[t]?this.pst[t][7-r][c]:0);
    }
    return g.turn==='w'?score:-score;
  }
  orderMoves(g,moves){
    return moves.sort((a,b)=>{
      let sa=0,sb=0;
      const ca=g.board[a.t[0]][a.t[1]],cb=g.board[b.t[0]][b.t[1]];
      if(ca)sa+=(this.pieceVal[ca.toLowerCase()]||0)*10;
      if(cb)sb+=(this.pieceVal[cb.toLowerCase()]||0)*10;
      if(a.pr)sa+=900;if(b.pr)sb+=900;
      return sb-sa;
    });
  }
  search(g,depth,alpha,beta){
    if(depth===0)return this.evaluate(g);
    let moves=g.legalMoves();
    if(!moves.length){if(g.inCheck(g.turn))return-99999+this.depth-depth;return 0}
    moves=this.orderMoves(g,moves);
    let best=-Infinity;
    for(const m of moves){
      const c=g.clone();c.applyMove(m);
      const score=-this.search(c,depth-1,-beta,-alpha);
      if(score>best)best=score;
      alpha=Math.max(alpha,score);
      if(alpha>=beta)break;
    }
    return best;
  }
  bestMove(g){
    let moves=g.legalMoves();if(!moves.length)return null;
    moves=this.orderMoves(g,moves);
    let best=moves[0],bestScore=-Infinity;
    for(const m of moves){
      const c=g.clone();c.applyMove(m);
      const score=-this.search(c,this.depth-1,-Infinity,Infinity);
      if(score>bestScore){bestScore=score;best=m}
    }
    best.score=bestScore;return best;
  }
  evalWhitePOV(g){
    const moves=g.legalMoves();
    if(!moves.length){if(g.inCheck(g.turn))return g.turn==='w'?-9999:9999;return 0}
    let best=-Infinity;
    for(const m of moves){
      const c=g.clone();c.applyMove(m);
      const score=-this.search(c,Math.min(this.depth-1,2),-Infinity,Infinity);
      if(score>best)best=score;
    }
    return g.turn==='w'?best:-best;
  }
}

// ======================== OPENINGS ========================
const OPENINGS={'':'Starting Position','e4':"King's Pawn",'e4 e5':"Open Game",'e4 e5 Nf3':"King's Knight",'e4 e5 Nf3 Nc6':'Four Knights Setup','e4 e5 Nf3 Nc6 Bb5':'Ruy Lopez','e4 e5 Nf3 Nc6 Bb5 a6':'Ruy Lopez: Morphy','e4 e5 Nf3 Nc6 Bc4':'Italian Game','e4 e5 Nf3 Nc6 Bc4 Bc5':'Giuoco Piano','e4 e5 Nf3 Nc6 Bc4 Nf6':'Two Knights','e4 e5 Nf3 Nc6 d4':'Scotch','e4 e5 Nf3 Nf6':'Petrov','e4 c5':'Sicilian','e4 c5 Nf3':'Sicilian','e4 c5 Nf3 d6':'Sicilian Najdorf/Dragon','e4 c5 Nf3 Nc6':'Sicilian','e4 c5 Nf3 e6':'Sicilian','e4 e6':'French','e4 e6 d4 d5':'French','e4 c6':'Caro-Kann','e4 c6 d4 d5':'Caro-Kann','e4 d5':'Scandinavian','e4 d6':'Pirc','e4 g6':'Modern','d4':"Queen's Pawn",'d4 d5':"Queen's Pawn Game",'d4 d5 c4':"Queen's Gambit",'d4 d5 c4 e6':'QGD','d4 d5 c4 dxc4':'QGA','d4 d5 c4 c6':'Slav','d4 Nf6':'Indian','d4 Nf6 c4':'Indian','d4 Nf6 c4 g6':"King's Indian",'d4 Nf6 c4 e6':'Nimzo/QID','d4 Nf6 c4 e6 Nc3 Bb4':'Nimzo-Indian','d4 Nf6 c4 c5':'Benoni','d4 f5':'Dutch','Nf3':'Reti','c4':'English','f4':'Bird'};

// ======================== GAME STATE ========================
let game=new Chess(),ai=new AI(3);
let selected=null,legalFor=[];
let playerColor='w',aiDepth=3;
let mode='setup';
let lastFrom=null,lastTo=null;
let timerID=null,wTime=600,bTime=600,timeCtrl=600;
let reviewIdx=-1,moveEvals=[],positionEvals=[];
let capturedWhite=[],capturedBlack=[];
let dragging=null,dragEl=null,dragStartSq=null;

// ======================== TABS ========================
function switchTab(tab){
  document.getElementById('tabPlay').classList.toggle('active',tab==='play');
  document.getElementById('tabReview').classList.toggle('active',tab==='review');
  if(tab==='play'){
    if(mode==='review'){mode='setup';clearHighlights()}
    document.getElementById('evalWrap').style.display='none';
    buildPanel();renderBoard();
  }else{
    if(game.history.length)startReview();
    else document.getElementById('panel').innerHTML=`<div class="card"><div class="setup-wrap"><h3><span class="icon">üìä</span> Game Review</h3><p style="color:#888">Play a game first to analyze it!</p></div></div>`;
  }
}

// ======================== PANEL ========================
function buildPanel(){
  const p=document.getElementById('panel');
  if(mode==='setup'){
    p.innerHTML=`<div class="card"><div class="setup-wrap">
      <h3><span class="icon">‚öîÔ∏è</span> Play vs Computer</h3>
      <div class="setup-group"><label>Play as</label><select id="selColor"><option value="w">‚ôî White</option><option value="b">‚ôö Black</option><option value="r">üé≤ Random</option></select></div>
      <div class="setup-group"><label>Difficulty</label><select id="selDiff"><option value="1">Easy (Depth 1)</option><option value="2">Medium (Depth 2)</option><option value="3" selected>Hard (Depth 3)</option><option value="4">Expert (Depth 4)</option></select></div>
      <div class="setup-group"><label>Time Control</label><select id="selTime"><option value="60">1 min</option><option value="180">3 min</option><option value="300">5 min</option><option value="600" selected>10 min</option><option value="0">‚àû Unlimited</option></select></div>
      <button class="btn-play" onclick="startGame()">‚ñ∂ PLAY</button>
    </div></div>`;
  }else if(mode==='playing'||mode==='gameover'){
    p.innerHTML=`<div class="card">
      <div class="card-header"><span class="icon">üìã</span> Moves</div>
      <div class="move-list" id="moveList">${buildMoveList()}</div>
      <div class="status-bar ${getStatusClass()}" id="statusBar">${statusMsg()}</div>
      ${mode==='gameover'?
        `<div class="controls"><button class="ctrl-btn" onclick="newGame()">üîÑ New</button><button class="ctrl-btn" onclick="startReview()">üìä Review</button></div>`:
        `<div style="padding:12px"><button class="btn-danger" onclick="resign()">üè≥Ô∏è Resign</button></div>`}
    </div>`;
    scrollMoveList();
  }
}

function buildMoveList(){
  let h='';
  for(let i=0;i<game.history.length;i+=2){
    const mn=Math.floor(i/2)+1;
    const wm=game.history[i],bm=game.history[i+1];
    const wIcon=getMoveIcon(i),bIcon=bm?getMoveIcon(i+1):'';
    const wActive=i===activeIdx()?'active':'';
    const bActive=bm&&i+1===activeIdx()?'active':'';
    h+=`<div class="move-row"><span class="move-num">${mn}.</span>
      <div class="move-cell ${wActive}" onclick="clickMove(${i})">${wIcon}${wm.san}</div>
      ${bm?`<div class="move-cell ${bActive}" onclick="clickMove(${i+1})">${bIcon}${bm.san}</div>`:`<div class="move-cell" style="visibility:hidden">-</div>`}
    </div>`;
  }
  return h;
}

function activeIdx(){return mode==='review'?reviewIdx:game.history.length-1}

function getMoveIcon(i){
  if(!moveEvals[i])return'';
  const c=moveEvals[i].cls;
  const sym={brilliant:'!!',great:'!',best:'‚òÖ',excellent:'!',good:'‚úì',book:'üìñ',inaccuracy:'?!',mistake:'?',blunder:'??',forced:'‚Üí'};
  return`<span class="m-icon ${c}">${sym[c]||''}</span>`;
}

function getStatusClass(){
  if(!game.over)return'';
  if(game.result==='1/2-1/2')return'draw';
  const won=(game.result==='1-0'&&playerColor==='w')||(game.result==='0-1'&&playerColor==='b');
  return won?'win':'lose';
}

function statusMsg(){
  if(game.over){
    if(game.result==='1-0')return playerColor==='w'?'üéâ You win!':'Black wins ‚Äî '+game.reason;
    if(game.result==='0-1')return playerColor==='b'?'üéâ You win!':'White wins ‚Äî '+game.reason;
    return'ü§ù Draw ‚Äî '+game.reason;
  }
  const indicator=`<span class="turn-indicator ${game.turn==='w'?'white':'black'}"></span>`;
  if(game.inCheck(game.turn))return indicator+(game.turn==='w'?'White':'Black')+' is in check!';
  return indicator+(game.turn==='w'?'White':'Black')+' to move';
}

function scrollMoveList(){setTimeout(()=>{const e=document.getElementById('moveList');if(e)e.scrollTop=e.scrollHeight},50)}

// ======================== GAME CONTROL ========================
function startGame(){
  const cs=document.getElementById('selColor').value;
  playerColor=cs==='r'?(Math.random()<.5?'w':'b'):cs;
  aiDepth=parseInt(document.getElementById('selDiff').value);
  timeCtrl=parseInt(document.getElementById('selTime').value);
  ai=new AI(aiDepth);game=new Chess();mode='playing';
  selected=null;legalFor=[];lastFrom=null;lastTo=null;
  moveEvals=[];positionEvals=[];capturedWhite=[];capturedBlack=[];
  wTime=timeCtrl||600;bTime=timeCtrl||600;
  document.getElementById('evalWrap').style.display='none';
  updatePlayerCards();renderBoard();buildPanel();updateClocks();startTimer();
  if(playerColor==='b')setTimeout(doAI,400);
}

function newGame(){
  document.getElementById('gameoverModal').classList.remove('show');
  mode='setup';game=new Chess();stopTimer();
  lastFrom=null;lastTo=null;capturedWhite=[];capturedBlack=[];
  document.getElementById('evalWrap').style.display='none';
  renderBoard();buildPanel();updateClocks();
}

function resign(){
  game.over=true;game.result=playerColor==='w'?'0-1':'1-0';game.reason='resignation';
  mode='gameover';stopTimer();sounds.gameEnd();showGameOver();
}

function showGameOver(){
  const m=document.getElementById('gameoverModal');
  const icon=document.getElementById('goIcon'),title=document.getElementById('goTitle'),msg=document.getElementById('goMsg');
  const won=(game.result==='1-0'&&playerColor==='w')||(game.result==='0-1'&&playerColor==='b');
  const draw=game.result==='1/2-1/2';
  icon.textContent=won?'üéâ':draw?'ü§ù':'üòî';
  if(game.result==='1-0'){title.textContent=playerColor==='w'?'Victory!':'Defeat';msg.textContent='White wins by '+game.reason}
  else if(game.result==='0-1'){title.textContent=playerColor==='b'?'Victory!':'Defeat';msg.textContent='Black wins by '+game.reason}
  else{title.textContent='Draw';msg.textContent=game.reason.charAt(0).toUpperCase()+game.reason.slice(1)}
  m.classList.add('show');buildPanel();
}

function updatePlayerCards(){
  const tName=document.getElementById('topName'),bName=document.getElementById('botName');
  const tRating=document.getElementById('topRating'),bRating=document.getElementById('botRating');
  const tAvatar=document.getElementById('topAvatar'),bAvatar=document.getElementById('botAvatar');
  if(playerColor==='w'){
    tName.textContent='Computer';bName.textContent='You';
    tRating.textContent='Depth '+aiDepth;bRating.textContent='Player';
    tAvatar.textContent='AI';tAvatar.className='player-avatar avatar-black';
    bAvatar.textContent='You';bAvatar.className='player-avatar avatar-white';
  }else{
    tName.textContent='You';bName.textContent='Computer';
    tRating.textContent='Player';bRating.textContent='Depth '+aiDepth;
    tAvatar.textContent='You';tAvatar.className='player-avatar avatar-white';
    bAvatar.textContent='AI';bAvatar.className='player-avatar avatar-black';
  }
}

// ======================== TIMER ========================
function startTimer(){stopTimer();if(!timeCtrl)return;
  timerID=setInterval(()=>{
    if(game.over||mode!=='playing'){stopTimer();return}
    if(game.turn==='w'){wTime=Math.max(0,wTime-1);if(!wTime){game.over=true;game.result='0-1';game.reason='timeout';mode='gameover';stopTimer();sounds.gameEnd();showGameOver()}}
    else{bTime=Math.max(0,bTime-1);if(!bTime){game.over=true;game.result='1-0';game.reason='timeout';mode='gameover';stopTimer();sounds.gameEnd();showGameOver()}}
    updateClocks();
  },1000);
}
function stopTimer(){if(timerID)clearInterval(timerID);timerID=null}
function fmtTime(s){return Math.floor(s/60)+':'+(s%60<10?'0':'')+(s%60)}
function updateClocks(){
  const tClock=document.getElementById('topClock'),bClock=document.getElementById('botClock');
  const tCard=document.getElementById('topCard'),bCard=document.getElementById('botCard');
  let tT,bT,tActive,bActive;
  if(playerColor==='w'){tT=bTime;bT=wTime;tActive=game.turn==='b'&&mode==='playing';bActive=game.turn==='w'&&mode==='playing'}
  else{tT=wTime;bT=bTime;tActive=game.turn==='w'&&mode==='playing';bActive=game.turn==='b'&&mode==='playing'}
  tClock.textContent=timeCtrl?fmtTime(tT):'‚àû';bClock.textContent=timeCtrl?fmtTime(bT):'‚àû';
  tClock.className='clock'+(tActive?' ticking':'')+(tT<30&&timeCtrl?' danger':'');
  bClock.className='clock'+(bActive?' ticking':'')+(bT<30&&timeCtrl?' danger':'');
  tCard.classList.toggle('active-turn',tActive);bCard.classList.toggle('active-turn',bActive);
}

// ======================== BOARD RENDERING ========================
function renderBoard(){
  const brd=document.getElementById('board');brd.innerHTML='';
  const board=mode==='review'?getReviewBoard():game.board;
  const flip=playerColor==='b'&&mode!=='review';
  
  for(let dr=0;dr<8;dr++)for(let dc=0;dc<8;dc++){
    const r=flip?7-dr:dr,c=flip?7-dc:dc;
    const isLight=(r+c)%2===0;
    const sq=document.createElement('div');
    sq.className='square'+(isLight?' sq-light':' sq-dark');
    sq.style.left=(dc*75)+'px';sq.style.top=(dr*75)+'px';
    sq.dataset.r=r;sq.dataset.c=c;
    
    const piece=board[r][c];
    if(piece){
      const img=document.createElement('img');img.src=PIECE_IMG[piece];img.alt=piece;img.draggable=false;
      sq.appendChild(img);
      if(mode==='playing'&&!game.over&&game.turn===playerColor&&game.color(piece)===playerColor){
        sq.classList.add('can-move');
      }
    }
    
    // Coordinates
    if(dc===0){const l=document.createElement('span');l.className='coord rank';l.textContent=8-r;sq.appendChild(l)}
    if(dr===7){const l=document.createElement('span');l.className='coord file';l.textContent='abcdefgh'[c];sq.appendChild(l)}
    
    // Highlights
    if(selected&&selected[0]===r&&selected[1]===c)sq.classList.add('selected');
    if(lastFrom&&lastFrom[0]===r&&lastFrom[1]===c)sq.classList.add('last-from');
    if(lastTo&&lastTo[0]===r&&lastTo[1]===c)sq.classList.add('last-to');
    if(legalFor.some(m=>m.t[0]===r&&m.t[1]===c))sq.classList.add(board[r][c]?'legal-capture':'legal-dot');
    if(mode!=='review'&&game.inCheck(game.turn)){const kp=game.findKing(game.turn);if(kp&&kp[0]===r&&kp[1]===c)sq.classList.add('check')}
    
    sq.addEventListener('mousedown',e=>onMouseDown(e,r,c));
    sq.addEventListener('click',()=>onClick(r,c));
    brd.appendChild(sq);
  }
  
  updateOpening();updateCaptured();updateMaterial();
}

function clearHighlights(){lastFrom=null;lastTo=null;selected=null;legalFor=[]}

// ======================== DRAG & DROP ========================
function onMouseDown(e,r,c){
  if(mode==='review'||mode!=='playing'||game.over||game.turn!==playerColor)return;
  const piece=game.board[r][c];
  if(!piece||game.color(piece)!==playerColor)return;
  
  e.preventDefault();
  selected=[r,c];
  legalFor=game.legalMoves(playerColor).filter(m=>m.f[0]===r&&m.f[1]===c);
  renderBoard();
  
  // Start dragging
  const sq=e.currentTarget;
  const img=sq.querySelector('img');
  if(!img)return;
  
  dragEl=document.createElement('img');
  dragEl.src=img.src;
  dragEl.className='dragging';
  document.body.appendChild(dragEl);
  img.style.opacity='0.3';
  
  dragStartSq={r,c,imgEl:img};
  dragging=true;
  
  moveDrag(e);
  document.addEventListener('mousemove',moveDrag);
  document.addEventListener('mouseup',endDrag);
}

function moveDrag(e){
  if(!dragEl)return;
  dragEl.style.left=e.clientX+'px';
  dragEl.style.top=e.clientY+'px';
}

function endDrag(e){
  document.removeEventListener('mousemove',moveDrag);
  document.removeEventListener('mouseup',endDrag);
  
  if(!dragging||!dragEl){dragging=false;return}
  
  // Find drop target
  dragEl.style.display='none';
  const dropTarget=document.elementFromPoint(e.clientX,e.clientY);
  dragEl.style.display='';
  
  if(dragEl.parentNode)dragEl.parentNode.removeChild(dragEl);
  dragEl=null;
  
  if(dragStartSq&&dragStartSq.imgEl)dragStartSq.imgEl.style.opacity='1';
  
  const sq=dropTarget?.closest('.square');
  if(sq){
    const tr=parseInt(sq.dataset.r),tc=parseInt(sq.dataset.c);
    const move=legalFor.find(m=>m.t[0]===tr&&m.t[1]===tc);
    if(move){
      const promos=legalFor.filter(m=>m.t[0]===tr&&m.t[1]===tc&&m.pr);
      if(promos.length){showPromo(tr,tc,promos)}
      else{executeMove(move)}
    }else{
      selected=null;legalFor=[];renderBoard();
      sounds.illegal();
    }
  }else{
    selected=null;legalFor=[];renderBoard();
  }
  
  dragStartSq=null;dragging=false;
}

// ======================== CLICK MOVEMENT ========================
function onClick(r,c){
  if(mode==='review'||mode!=='playing'||game.over||game.turn!==playerColor)return;
  if(dragging)return;
  
  const piece=game.board[r][c];
  
  if(selected){
    const move=legalFor.find(m=>m.t[0]===r&&m.t[1]===c);
    if(move){
      const promos=legalFor.filter(m=>m.t[0]===r&&m.t[1]===c&&m.pr);
      if(promos.length){showPromo(r,c,promos);return}
      executeMove(move);return;
    }
    if(piece&&game.color(piece)===playerColor){select(r,c);return}
    selected=null;legalFor=[];renderBoard();return;
  }
  
  if(piece&&game.color(piece)===playerColor)select(r,c);
}

function select(r,c){
  selected=[r,c];
  legalFor=game.legalMoves(playerColor).filter(m=>m.f[0]===r&&m.f[1]===c);
  renderBoard();
}

function showPromo(r,c,moves){
  const box=document.getElementById('promoBox');box.innerHTML='';
  const pcs=playerColor==='w'?['Q','R','B','N']:['q','r','b','n'];
  pcs.forEach((pc,i)=>{
    const btn=document.createElement('button');
    const img=document
