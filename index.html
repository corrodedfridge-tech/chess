<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-darkest: #262421;
            --bg-darker: #302e2b;
            --bg-dark: #3d3b38;
            --bg-medium: #4a4847;
            --accent-green: #81b64c;
            --accent-green-dark: #629924;
            --text-white: #ffffff;
            --text-light: #bababa;
            --text-muted: #888888;
            --light-square: #ebecd0;
            --dark-square: #779556;
            --brilliant: #1baca6;
            --great: #5c8bb0;
            --best: #98bc4b;
            --blunder: #ca3431;
            --mistake: #e69d00;
            --inaccuracy: #f7c631;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-darkest);
            min-height: 100vh;
            color: var(--text-white);
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { 0% { transform: scale(0); } 70% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        @keyframes megaShake { 0%, 100% { transform: translate(0) rotate(0); } 10% { transform: translate(-15px, -10px) rotate(-2deg); } 20% { transform: translate(15px, 10px) rotate(2deg); } 30% { transform: translate(-10px, 5px) rotate(-1deg); } 40% { transform: translate(10px, -5px) rotate(1deg); } 50% { transform: translate(-5px, 5px) rotate(-0.5deg); } }
        @keyframes kingFall { 0% { transform: rotate(0) scale(1); } 100% { transform: rotate(-90deg) scale(0.7) translateY(20px); opacity: 0.4; } }
        @keyframes checkPulse { 0%, 100% { box-shadow: inset 0 0 30px rgba(255,0,0,0.5); } 50% { box-shadow: inset 0 0 60px rgba(255,0,0,0.9); } }
        @keyframes brilliantGlow { 0%, 100% { filter: drop-shadow(0 0 15px #1baca6) drop-shadow(0 0 30px #1baca6); } 50% { filter: drop-shadow(0 0 30px #1baca6) drop-shadow(0 0 60px #1baca6); } }
        @keyframes greatGlow { 0%, 100% { filter: drop-shadow(0 0 10px #5c8bb0) drop-shadow(0 0 20px #5c8bb0); } 50% { filter: drop-shadow(0 0 20px #5c8bb0) drop-shadow(0 0 40px #5c8bb0); } }
        @keyframes brilliantSquare { 0%, 100% { background: rgba(27,172,166,0.4) !important; } 50% { background: rgba(27,172,166,0.6) !important; } }
        @keyframes greatSquare { 0%, 100% { background: rgba(92,139,176,0.3) !important; } 50% { background: rgba(92,139,176,0.5) !important; } }
        @keyframes particle { 0% { transform: translate(0,0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }
        @keyframes explodeRing { 0% { transform: scale(0); opacity: 1; } 100% { transform: scale(4); opacity: 0; } }
        @keyframes confetti { 0% { transform: translateY(-100vh) rotate(0); } 100% { transform: translateY(100vh) rotate(720deg); } }
        @keyframes textPop { 0% { transform: scale(0) rotate(-20deg); opacity: 0; } 50% { transform: scale(1.3) rotate(5deg); opacity: 1; } 100% { transform: scale(1) rotate(0); } }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes screenFlash { 0% { opacity: 0; } 10% { opacity: 0.8; } 100% { opacity: 0; } }
        @keyframes moveIconPop { 0% { transform: scale(0) rotate(-180deg); } 100% { transform: scale(1) rotate(0); } }
        @keyframes pieceMove { 0% { } 100% { } }

        .header {
            background: linear-gradient(180deg, #302e2b, #272522);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 22px;
            font-weight: 800;
            color: white;
            text-decoration: none;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-green-dark));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .nav-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-dark);
            padding: 4px;
            border-radius: 10px;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: var(--text-light);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            transition: all 0.2s;
        }

        .nav-btn:hover { background: var(--bg-medium); color: white; }
        .nav-btn.active { background: var(--accent-green); color: white; }

        .header-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .elo-control {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .elo-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }

        .elo-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .elo-value {
            font-size: 20px;
            font-weight: 800;
            color: var(--accent-green);
            min-width: 50px;
        }

        .elo-slider {
            width: 180px;
            height: 8px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, #ca3431, #f7c631 40%, #81b64c 70%, #1baca6);
            border-radius: 4px;
            cursor: pointer;
        }

        .elo-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .elo-desc { font-size: 11px; color: var(--text-muted); }

        .main-container {
            display: flex;
            justify-content: center;
            padding: 30px;
            gap: 24px;
        }

        .board-area { display: flex; flex-direction: column; gap: 8px; }

        .board-row {
            display: flex;
            gap: 10px;
        }

        .eval-bar {
            width: 28px;
            height: 640px;
            background: #333;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .eval-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: white;
            transition: height 0.5s;
        }

        .eval-text {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 10px;
            font-weight: 700;
            padding: 3px 0;
        }

        .eval-text.top { top: 0; color: white; }
        .eval-text.bottom { bottom: 0; color: black; }

        .board-wrapper {
            position: relative;
        }

        .board {
            width: 640px;
            height: 640px;
            display: grid;
            grid-template-columns: repeat(8, 80px);
            grid-template-rows: repeat(8, 80px);
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .square {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
        }

        .square.light { background: var(--light-square); }
        .square.dark { background: var(--dark-square); }
        .square.selected { background: rgba(255,255,0,0.5) !important; }
        .square.last-move { background: rgba(255,255,0,0.4) !important; }
        .square.check { background: radial-gradient(circle, rgba(255,0,0,0.8), rgba(255,0,0,0.3) 50%, transparent 70%) !important; animation: checkPulse 0.8s infinite; }
        .square.brilliant-square { animation: brilliantSquare 1s infinite !important; }
        .square.great-square { animation: greatSquare 1s infinite !important; }

        .square.legal-move::after {
            content: '';
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.15);
            border-radius: 50%;
            position: absolute;
        }

        .square.legal-capture::after {
            content: '';
            width: 100%;
            height: 100%;
            border: 6px solid rgba(0,0,0,0.15);
            border-radius: 50%;
            position: absolute;
            box-sizing: border-box;
        }

        .piece {
            width: 90%;
            height: 90%;
            cursor: grab;
            z-index: 10;
            filter: drop-shadow(2px 4px 3px rgba(0,0,0,0.3));
            transition: transform 0.1s;
        }

        .piece:hover { transform: scale(1.05); }
        .piece.brilliant-glow { animation: brilliantGlow 1s infinite; }
        .piece.great-glow { animation: greatGlow 1s infinite; }
        .piece.king-fallen { animation: kingFall 1s forwards; }

        .ghost-piece {
            position: fixed;
            width: 90px;
            height: 90px;
            pointer-events: none;
            z-index: 10000;
            filter: drop-shadow(4px 8px 8px rgba(0,0,0,0.4));
            transform: translate(-50%, -50%);
        }

        .coord {
            position: absolute;
            font-size: 11px;
            font-weight: 700;
            pointer-events: none;
        }

        .coord.rank { top: 2px; left: 4px; }
        .coord.file { bottom: 2px; right: 4px; }
        .square.light .coord { color: var(--dark-square); }
        .square.dark .coord { color: var(--light-square); }

        .move-icon {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 24px;
            height: 24px;
            z-index: 20;
            animation: moveIconPop 0.4s;
        }

        .captured-row {
            height: 30px;
            display: flex;
            align-items: center;
            gap: 2px;
            padding-left: 38px;
        }

        .captured-piece { width: 22px; height: 22px; opacity: 0.85; }
        .material-diff { font-size: 14px; font-weight: 700; margin-left: 8px; color: var(--accent-green); }

        /* Side Panel */
        .side-panel {
            width: 360px;
            background: var(--bg-darker);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .player-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--bg-dark);
        }

        .player-bar.active { background: linear-gradient(90deg, rgba(129,182,76,0.2), var(--bg-dark)); border-left: 4px solid var(--accent-green); }

        .player-avatar {
            width: 44px;
            height: 44px;
            background: var(--bg-medium);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .player-info { flex: 1; }
        .player-name { font-weight: 700; font-size: 14px; }
        .player-rating { font-size: 12px; color: var(--text-muted); }

        .player-clock {
            padding: 8px 14px;
            background: var(--bg-darkest);
            border-radius: 6px;
            font-size: 20px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .player-clock.active { background: var(--accent-green); }

        .thinking-bar {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-darkest);
            color: var(--text-muted);
            font-size: 13px;
        }

        .thinking-bar.show { display: flex; }

        .dots { display: flex; gap: 4px; }
        .dots span { width: 8px; height: 8px; background: var(--accent-green); border-radius: 50%; animation: pulse 1s infinite; }
        .dots span:nth-child(2) { animation-delay: 0.15s; }
        .dots span:nth-child(3) { animation-delay: 0.3s; }

        .tabs {
            display: flex;
            background: var(--bg-darkest);
            padding: 4px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            border-radius: 6px;
        }

        .tab:hover { color: var(--text-light); }
        .tab.active { background: var(--bg-medium); color: white; }

        .moves-panel {
            flex: 1;
            min-height: 250px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }

        .moves-panel::-webkit-scrollbar { width: 6px; }
        .moves-panel::-webkit-scrollbar-thumb { background: var(--bg-medium); border-radius: 3px; }

        .move-row {
            display: flex;
            align-items: center;
            padding: 2px 0;
        }

        .move-num { width: 28px; color: var(--text-muted); font-size: 12px; text-align: center; }

        .move {
            flex: 1;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .move:hover { background: var(--bg-dark); }
        .move.current { background: var(--bg-medium); }
        .move img { width: 18px; height: 18px; }

        .game-status {
            padding: 12px;
            text-align: center;
            font-weight: 700;
            font-size: 15px;
        }

        .game-status.win { color: var(--accent-green); }
        .game-status.loss { color: var(--blunder); }

        .controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background: var(--bg-darkest);
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .ctrl-btn {
            width: 44px;
            height: 44px;
            background: var(--bg-dark);
            border: none;
            border-radius: 8px;
            color: var(--text-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.15s;
        }

        .ctrl-btn:hover { background: var(--bg-medium); color: white; }
        .ctrl-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .action-btns {
            display: flex;
            gap: 10px;
            padding: 14px;
        }

        .btn-new {
            flex: 1;
            padding: 14px 20px;
            background: var(--accent-green);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 15px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-new:hover { background: var(--accent-green-dark); transform: translateY(-2px); }

        .btn-resign {
            padding: 14px 18px;
            background: var(--bg-dark);
            border: 2px solid var(--bg-medium);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-resign:hover { background: var(--blunder); border-color: var(--blunder); color: white; }

        /* Review Panel */
        .review-panel {
            display: none;
            padding: 16px;
            max-height: 380px;
            overflow-y: auto;
        }

        .review-panel.active { display: block; }

        .accuracy-section {
            display: flex;
            justify-content: center;
            gap: 40px;
            padding: 20px 0;
        }

        .accuracy-item { text-align: center; }

        .accuracy-ring {
            width: 90px;
            height: 90px;
            position: relative;
            margin: 0 auto 10px;
        }

        .accuracy-ring svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .accuracy-ring circle { fill: none; stroke-width: 8; }
        .accuracy-ring .bg { stroke: var(--bg-dark); }
        .accuracy-ring .prog { stroke-linecap: round; transition: stroke-dashoffset 1s; }
        .accuracy-ring.white .prog { stroke: white; }
        .accuracy-ring.black .prog { stroke: var(--text-muted); }

        .accuracy-val {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 22px;
            font-weight: 800;
        }

        .accuracy-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; }

        .class-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .class-label { display: flex; align-items: center; gap: 10px; }
        .class-label img { width: 22px; height: 22px; }
        .class-label span { font-size: 12px; }

        .class-counts { display: flex; gap: 8px; }
        .class-count {
            width: 36px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            padding: 4px 0;
            background: var(--bg-dark);
            border-radius: 4px;
        }

        .class-count.has { background: var(--bg-medium); }

        .review-move-box {
            background: var(--bg-dark);
            border-radius: 8px;
            margin-top: 12px;
            overflow: hidden;
        }

        .review-move-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-darkest);
        }

        .review-move-info { display: flex; align-items: center; gap: 10px; }
        .review-move-info img { width: 24px; height: 24px; }
        .review-move-notation { font-size: 16px; font-weight: 700; }
        .review-move-type { font-size: 12px; color: var(--text-muted); }

        .eval-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 700;
        }

        .eval-badge.pos { background: rgba(129,182,76,0.2); color: var(--accent-green); }
        .eval-badge.neg { background: rgba(202,52,49,0.2); color: var(--blunder); }

        .review-best {
            padding: 10px 12px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .review-best strong { color: var(--accent-green); }

        .empty-state {
            padding: 40px;
            text-align: center;
            color: var(--text-muted);
        }

        .empty-state-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
        .empty-state-text { font-size: 14px; line-height: 1.6; }

        /* Modals */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active { display: flex; animation: fadeIn 0.3s; }

        .modal {
            background: linear-gradient(180deg, var(--bg-darker), var(--bg-darkest));
            padding: 40px 50px;
            border-radius: 20px;
            text-align: center;
            max-width: 450px;
        }

        .modal-icon { font-size: 70px; margin-bottom: 20px; animation: popIn 0.5s; }
        .modal-title { font-size: 36px; font-weight: 900; margin-bottom: 10px; }
        .modal-msg { color: var(--text-muted); font-size: 16px; margin-bottom: 30px; }

        .modal-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 24px;
        }

        .modal-stat { text-align: center; }
        .modal-stat-val { font-size: 26px; font-weight: 800; color: var(--accent-green); }
        .modal-stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; }

        .modal-btns { display: flex; gap: 12px; justify-content: center; }

        .modal-btn {
            padding: 14px 30px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .modal-btn.primary { background: var(--accent-green); color: white; }
        .modal-btn.primary:hover { background: var(--accent-green-dark); }
        .modal-btn.secondary { background: var(--bg-dark); color: var(--text-light); }
        .modal-btn.secondary:hover { background: var(--bg-medium); }

        .promo-modal .modal { padding: 24px; }
        .promo-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text-light); }
        .promo-pieces { display: flex; gap: 10px; justify-content: center; }

        .promo-piece {
            width: 80px;
            height: 80px;
            background: var(--bg-dark);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .promo-piece:hover { border-color: var(--accent-green); transform: scale(1.1); }
        .promo-piece img { width: 65px; height: 65px; }

        /* Particles */
        .particles {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            animation: particle 1.2s ease-out forwards;
        }

        .ring {
            position: absolute;
            border: 4px solid;
            border-radius: 50%;
            animation: explodeRing 0.7s ease-out forwards;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 20px;
            animation: confetti 3s ease-out forwards;
        }

        .popup-text {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 64px;
            font-weight: 900;
            z-index: 100000;
            pointer-events: none;
            text-shadow: 0 0 30px currentColor;
            animation: textPop 1.5s ease-out forwards;
        }

        .popup-text.brilliant { color: var(--brilliant); }
        .popup-text.great { color: var(--great); }

        .screen-flash {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 99998;
            animation: screenFlash 0.4s ease-out forwards;
        }

        .screen-flash.white { background: white; }
        .screen-flash.brilliant { background: var(--brilliant); }
        .screen-flash.great { background: var(--great); }

        /* Animated piece for review */
        .anim-piece {
            position: absolute;
            width: 72px;
            height: 72px;
            z-index: 100;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            filter: drop-shadow(3px 6px 6px rgba(0,0,0,0.4));
        }

        .anim-piece.brilliant { animation: brilliantGlow 0.5s; }
        .anim-piece.great { animation: greatGlow 0.5s; }

        /* Spinner */
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--bg-dark);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }

        .analyzing { padding: 50px; text-align: center; }
        .analyzing-text { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
        .analyzing-sub { font-size: 13px; color: var(--text-muted); }

        .progress-bar {
            width: 180px;
            height: 4px;
            background: var(--bg-dark);
            border-radius: 2px;
            margin: 16px auto 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-green);
            width: 0%;
            transition: width 0.2s;
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>

    <header class="header">
        <a href="#" class="logo">
            <div class="logo-icon">‚ôû</div>
            <span>Chess</span>
        </a>

        <div class="nav-tabs">
            <button class="nav-btn active" id="playTab" onclick="showPlay()">Play</button>
            <button class="nav-btn" id="reviewTab" onclick="startReview()">Game Review</button>
        </div>

        <div class="header-right">
            <div class="elo-control">
                <span class="elo-label">Bot Strength</span>
                <div class="elo-row">
                    <span class="elo-value" id="eloVal">1500</span>
                    <input type="range" class="elo-slider" id="eloSlider" min="0" max="3200" step="100" value="1500">
                    <span class="elo-desc" id="eloDesc">Intermediate</span>
                </div>
            </div>
        </div>
    </header>

    <main class="main-container">
        <section class="board-area">
            <div class="captured-row" id="capBlack"></div>

            <div class="board-row">
                <div class="eval-bar">
                    <div class="eval-fill" id="evalFill" style="height:50%"></div>
                    <div class="eval-text top" id="evalTop"></div>
                    <div class="eval-text bottom" id="evalBot">0.0</div>
                </div>

                <div class="board-wrapper">
                    <div class="board" id="board"></div>
                </div>
            </div>

            <div class="captured-row" id="capWhite"></div>
        </section>

        <aside class="side-panel">
            <div class="player-bar" id="blackBar">
                <div class="player-avatar">ü§ñ</div>
                <div class="player-info">
                    <div class="player-name" id="botName">Chess Bot</div>
                    <div class="player-rating" id="botRating">ELO 1500</div>
                </div>
                <div class="player-clock" id="blackClock">10:00</div>
            </div>

            <div class="thinking-bar" id="thinking">
                <span>Calculating</span>
                <div class="dots"><span></span><span></span><span></span></div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('moves')">Moves</button>
                <button class="tab" onclick="showTab('analysis')">Analysis</button>
            </div>

            <div class="moves-panel" id="movesPanel"></div>
            <div class="review-panel" id="reviewPanel"></div>

            <div class="game-status" id="status"></div>

            <div class="controls">
                <button class="ctrl-btn" onclick="goStart()">‚èÆ</button>
                <button class="ctrl-btn" onclick="goBack()">‚óÄ</button>
                <button class="ctrl-btn" onclick="goNext()">‚ñ∂</button>
                <button class="ctrl-btn" onclick="goEnd()">‚è≠</button>
            </div>

            <div class="player-bar active" id="whiteBar">
                <div class="player-avatar">üë§</div>
                <div class="player-info">
                    <div class="player-name">You</div>
                    <div class="player-rating">Playing as White</div>
                </div>
                <div class="player-clock active" id="whiteClock">10:00</div>
            </div>

            <div class="action-btns">
                <button class="btn-new" onclick="newGame()">New Game</button>
                <button class="btn-resign" onclick="resignGame()">Resign</button>
            </div>
        </aside>
    </main>

    <!-- Game Over Modal -->
    <div class="modal-overlay" id="gameOverModal">
        <div class="modal" id="modalContent">
            <div class="modal-icon" id="modalIcon">üëë</div>
            <h2 class="modal-title" id="modalTitle">Victory!</h2>
            <p class="modal-msg" id="modalMsg">You won by checkmate!</p>
            <div class="modal-stats">
                <div class="modal-stat">
                    <div class="modal-stat-val" id="statMoves">0</div>
                    <div class="modal-stat-label">Moves</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-val" id="statAcc">-</div>
                    <div class="modal-stat-label">Accuracy</div>
                </div>
            </div>
            <div class="modal-btns">
                <button class="modal-btn primary" onclick="newGame()">Play Again</button>
                <button class="modal-btn secondary" onclick="closeModals(); startReview();">Review</button>
            </div>
        </div>
    </div>

    <!-- Promotion Modal -->
    <div class="modal-overlay promo-modal" id="promoModal">
        <div class="modal">
            <div class="promo-title">Choose piece</div>
            <div class="promo-pieces" id="promoPieces"></div>
        </div>
    </div>

<script>
// Piece images (using raw GitHub content)
const PIECES = {
    'K': 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/whiteking.png',
    'Q': 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/whitequeen.png',
    'R': 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/whiterook.png',
    'B': 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/whitebishop.png',
    'N': 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/whiteknight.png',
    'P': 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/whitepawn.png',
    'k': 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/blackking.png',
    'q': 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/blackqueen.png',
    'r': 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/blackrook.png',
    'b': 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/blackbishop.png',
    'n': 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/blackknight.png',
    'p': 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/blackpawn.png'
};

const CLASS_ICONS = {
    brilliant: 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/brilliantmove.png',
    great: 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/greatmove.png',
    best: 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/bestmove.png',
    good: 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/goodmove.png',
    book: 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/bookmove.png',
    inaccuracy: 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/innacuracy.png',
    mistake: 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/mistake.png',
    blunder: 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/blunder.png',
    excellent: 'https://raw.githubusercontent.com/corrodedfridge-tech/chess/main/goodmove.png'
};

const ELO_DESC = { 0:"Tries to lose",400:"Beginner",800:"Casual",1200:"Club player",1500:"Intermediate",1800:"Expert",2200:"Master",2600:"GM",3200:"Unbeatable" };

// Audio
let audioCtx;
function sound(type) {
    try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        if (type === 'move') {
            osc.frequency.value = 400; osc.type = 'sine';
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
            osc.start(now); osc.stop(now + 0.15);
        } else if (type === 'capture') {
            osc.frequency.value = 200; osc.type = 'sawtooth';
            gain.gain.setValueAtTime(0.15, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
            osc.start(now); osc.stop(now + 0.25);
        } else if (type === 'check') {
            osc.frequency.value = 800; osc.type = 'square';
            gain.gain.setValueAtTime(0.08, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
            osc.start(now); osc.stop(now + 0.2);
        } else if (type === 'brilliant') {
            [523, 659, 784, 1047, 1319].forEach((f, i) => {
                const o = audioCtx.createOscillator(), g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.frequency.value = f; o.type = 'sine';
                g.gain.setValueAtTime(0.15, now + i*0.08);
                g.gain.exponentialRampToValueAtTime(0.001, now + i*0.08 + 0.4);
                o.start(now + i*0.08); o.stop(now + i*0.08 + 0.5);
            });
        } else if (type === 'great') {
            [440, 554, 659, 880].forEach((f, i) => {
                const o = audioCtx.createOscillator(), g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.frequency.value = f; o.type = 'sine';
                g.gain.setValueAtTime(0.12, now + i*0.1);
                g.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 0.3);
                o.start(now + i*0.1); o.stop(now + i*0.1 + 0.4);
            });
        } else if (type === 'victory') {
            [523, 659, 784, 1047].forEach((f, i) => {
                const o = audioCtx.createOscillator(), g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.frequency.value = f; o.type = 'sine';
                g.gain.setValueAtTime(0.12, now + i*0.15);
                g.gain.exponentialRampToValueAtTime(0.001, now + i*0.15 + 0.5);
                o.start(now + i*0.15); o.stop(now + i*0.15 + 0.6);
            });
        } else if (type === 'defeat') {
            [392, 349, 294, 220].forEach((f, i) => {
                const o = audioCtx.createOscillator(), g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.frequency.value = f; o.type = 'sine';
                g.gain.setValueAtTime(0.1, now + i*0.2);
                g.gain.exponentialRampToValueAtTime(0.001, now + i*0.2 + 0.5);
                o.start(now + i*0.2); o.stop(now + i*0.2 + 0.6);
            });
        }
    } catch(e) {}
}

// Particles
function particles(x, y, count, colors) {
    const container = document.getElementById('particles');
    for (let i = 0; i < count; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        const angle = (Math.PI * 2 * i) / count;
        const dist = 80 + Math.random() * 80;
        p.style.cssText = `left:${x}px;top:${y}px;width:${6+Math.random()*8}px;height:${6+Math.random()*8}px;background:${colors[i%colors.length]};--tx:${Math.cos(angle)*dist}px;--ty:${Math.sin(angle)*dist}px`;
        container.appendChild(p);
        setTimeout(() => p.remove(), 1200);
    }
}

function rings(x, y, colors) {
    const container = document.getElementById('particles');
    colors.forEach((c, i) => {
        const r = document.createElement('div');
        r.className = 'ring';
        r.style.cssText = `left:${x-20}px;top:${y-20}px;width:40px;height:40px;border-color:${c};animation-delay:${i*0.1}s`;
        container.appendChild(r);
        setTimeout(() => r.remove(), 800);
    });
}

function confetti(count) {
    const container = document.getElementById('particles');
    const colors = ['#ff6b6b','#ffd93d','#6bcb77','#4d96ff','#ff6bb5','#fff'];
    for (let i = 0; i < count; i++) {
        const c = document.createElement('div');
        c.className = 'confetti-piece';
        c.style.cssText = `left:${Math.random()*100}%;top:-20px;background:${colors[i%colors.length]};animation-delay:${Math.random()*2}s`;
        container.appendChild(c);
        setTimeout(() => c.remove(), 4000);
    }
}

function screenFlash(type) {
    const f = document.createElement('div');
    f.className = `screen-flash ${type}`;
    document.body.appendChild(f);
    setTimeout(() => f.remove(), 400);
}

function popup(text, cls) {
    const p = document.createElement('div');
    p.className = `popup-text ${cls}`;
    p.textContent = text;
    document.body.appendChild(p);
    setTimeout(() => p.remove(), 1500);
}

function brilliantEffect(sq) {
    const rect = sq.getBoundingClientRect();
    const x = rect.left + 40, y = rect.top + 40;
    screenFlash('brilliant');
    particles(x, y, 50, ['#1baca6','#26d9ca','#fff','#a8f0ed']);
    rings(x, y, ['#1baca6','#26d9ca','#fff']);
    popup('‚ú® BRILLIANT!! ‚ú®', 'brilliant');
    sound('brilliant');
    sq.classList.add('brilliant-square');
    const pc = sq.querySelector('.piece');
    if (pc) pc.classList.add('brilliant-glow');
    setTimeout(() => { sq.classList.remove('brilliant-square'); if(pc) pc.classList.remove('brilliant-glow'); }, 3000);
    document.querySelector('.board-wrapper').style.animation = 'shake 0.5s';
    setTimeout(() => document.querySelector('.board-wrapper').style.animation = '', 500);
}

function greatEffect(sq) {
    const rect = sq.getBoundingClientRect();
    const x = rect.left + 40, y = rect.top + 40;
    screenFlash('great');
    particles(x, y, 30, ['#5c8bb0','#7ab3d9','#fff']);
    rings(x, y, ['#5c8bb0','#7ab3d9']);
    popup('üéØ GREAT!', 'great');
    sound('great');
    sq.classList.add('great-square');
    const pc = sq.querySelector('.piece');
    if (pc) pc.classList.add('great-glow');
    setTimeout(() => { sq.classList.remove('great-square'); if(pc) pc.classList.remove('great-glow'); }, 2000);
}

function checkmateAnim(kingPos, won) {
    const board = document.getElementById('board');
    const rect = board.getBoundingClientRect();
    const x = rect.left + kingPos.col * 80 + 40;
    const y = rect.top + kingPos.row * 80 + 40;

    screenFlash('white');
    const king = document.querySelector(`.square[data-row="${kingPos.row}"][data-col="${kingPos.col}"] .piece`);
    if (king) king.classList.add('king-fallen');

    document.querySelector('.board-wrapper').style.animation = 'megaShake 1s';
    setTimeout(() => document.querySelector('.board-wrapper').style.animation = '', 1000);

    setTimeout(() => {
        particles(x, y, 60, won ? ['#81b64c','#a8e063','#fff','#ffd700'] : ['#ca3431','#ff6b6b','#333']);
        rings(x, y, ['#fff','#ffd700','#81b64c']);
    }, 100);

    if (won) setTimeout(() => confetti(60), 500);
    sound(won ? 'victory' : 'defeat');
}

// Chess Engine
class Engine {
    constructor() { this.reset(); }

    reset() {
        this.board = [
            ['r','n','b','q','k','b','n','r'],
            ['p','p','p','p','p','p','p','p'],
            [null,null,null,null,null,null,null,null],
            [null,null,null,null,null,null,null,null],
            [null,null,null,null,null,null,null,null],
            [null,null,null,null,null,null,null,null],
            ['P','P','P','P','P','P','P','P'],
            ['R','N','B','Q','K','B','N','R']
        ];
        this.turn = 'white';
        this.castling = {K:true,Q:true,k:true,q:true};
        this.enPassant = null;
        this.history = [];
        this.captured = {white:[], black:[]};
    }

    clone() {
        const c = new Engine();
        c.board = this.board.map(r => [...r]);
        c.turn = this.turn;
        c.castling = {...this.castling};
        c.enPassant = this.enPassant;
        c.history = [...this.history];
        c.captured = {white:[...this.captured.white], black:[...this.captured.black]};
        return c;
    }

    isWhite(p) { return p && p === p.toUpperCase(); }
    color(p) { return p ? (this.isWhite(p) ? 'white' : 'black') : null; }

    kingPos(color) {
        const k = color === 'white' ? 'K' : 'k';
        for (let r = 0; r < 8; r++) for (let c = 0; c < 8; c++) if (this.board[r][c] === k) return {row:r,col:c};
        return null;
    }

    attacked(row, col, by) {
        const pDir = by === 'white' ? 1 : -1;
        const pawn = by === 'white' ? 'P' : 'p';
        if (row+pDir >= 0 && row+pDir < 8) {
            if (col > 0 && this.board[row+pDir][col-1] === pawn) return true;
            if (col < 7 && this.board[row+pDir][col+1] === pawn) return true;
        }
        const knight = by === 'white' ? 'N' : 'n';
        for (const [dr,dc] of [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]]) {
            const r = row+dr, c = col+dc;
            if (r >= 0 && r < 8 && c >= 0 && c < 8 && this.board[r][c] === knight) return true;
        }
        const king = by === 'white' ? 'K' : 'k';
        for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) {
            if (!dr && !dc) continue;
            const r = row+dr, c = col+dc;
            if (r >= 0 && r < 8 && c >= 0 && c < 8 && this.board[r][c] === king) return true;
        }
        const dirs = [
            {dr:-1,dc:0,p:by==='white'?['R','Q']:['r','q']},{dr:1,dc:0,p:by==='white'?['R','Q']:['r','q']},
            {dr:0,dc:-1,p:by==='white'?['R','Q']:['r','q']},{dr:0,dc:1,p:by==='white'?['R','Q']:['r','q']},
            {dr:-1,dc:-1,p:by==='white'?['B','Q']:['b','q']},{dr:-1,dc:1,p:by==='white'?['B','Q']:['b','q']},
            {dr:1,dc:-1,p:by==='white'?['B','Q']:['b','q']},{dr:1,dc:1,p:by==='white'?['B','Q']:['b','q']}
        ];
        for (const {dr,dc,p} of dirs) {
            let r = row+dr, c = col+dc;
            while (r >= 0 && r < 8 && c >= 0 && c < 8) {
                if (this.board[r][c]) { if (p.includes(this.board[r][c])) return true; break; }
                r += dr; c += dc;
            }
        }
        return false;
    }

    inCheck(color) {
        const k = this.kingPos(color);
        return k ? this.attacked(k.row, k.col, color === 'white' ? 'black' : 'white') : false;
    }

    moves(color = this.turn) {
        const list = [];
        for (let r = 0; r < 8; r++) {
            for (let c = 0; c < 8; c++) {
                const p = this.board[r][c];
                if (!p || this.color(p) !== color) continue;
                const t = p.toUpperCase();

                if (t === 'P') {
                    const dir = color === 'white' ? -1 : 1;
                    const start = color === 'white' ? 6 : 1;
                    const promo = color === 'white' ? 0 : 7;

                    if (!this.board[r+dir]?.[c]) {
                        if (r+dir === promo) ['Q','R','B','N'].forEach(pr => list.push({from:{row:r,col:c},to:{row:r+dir,col:c},promo:pr}));
                        else {
                            list.push({from:{row:r,col:c},to:{row:r+dir,col:c}});
                            if (r === start && !this.board[r+2*dir][c]) list.push({from:{row:r,col:c},to:{row:r+2*dir,col:c}});
                        }
                    }
                    for (const dc of [-1,1]) {
                        const nc = c+dc;
                        if (nc < 0 || nc > 7) continue;
                        const tgt = this.board[r+dir]?.[nc];
                        const ep = this.enPassant && this.enPassant.row === r+dir && this.enPassant.col === nc;
                        if ((tgt && this.color(tgt) !== color) || ep) {
                            if (r+dir === promo) ['Q','R','B','N'].forEach(pr => list.push({from:{row:r,col:c},to:{row:r+dir,col:nc},promo:pr,ep}));
                            else list.push({from:{row:r,col:c},to:{row:r+dir,col:nc},ep});
                        }
                    }
                }

                if (t === 'N') {
                    for (const [dr,dc] of [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]]) {
                        const nr = r+dr, nc = c+dc;
                        if (nr >= 0 && nr < 8 && nc >= 0 && nc < 8 && this.color(this.board[nr][nc]) !== color)
                            list.push({from:{row:r,col:c},to:{row:nr,col:nc}});
                    }
                }

                if (t === 'B' || t === 'Q') {
                    for (const [dr,dc] of [[-1,-1],[-1,1],[1,-1],[1,1]]) {
                        let nr = r+dr, nc = c+dc;
                        while (nr >= 0 && nr < 8 && nc >= 0 && nc < 8) {
                            if (!this.board[nr][nc]) list.push({from:{row:r,col:c},to:{row:nr,col:nc}});
                            else { if (this.color(this.board[nr][nc]) !== color) list.push({from:{row:r,col:c},to:{row:nr,col:nc}}); break; }
                            nr += dr; nc += dc;
                        }
                    }
                }

                if (t === 'R' || t === 'Q') {
                    for (const [dr,dc] of [[-1,0],[1,0],[0,-1],[0,1]]) {
                        let nr = r+dr, nc = c+dc;
                        while (nr >= 0 && nr < 8 && nc >= 0 && nc < 8) {
                            if (!this.board[nr][nc]) list.push({from:{row:r,col:c},to:{row:nr,col:nc}});
                            else { if (this.color(this.board[nr][nc]) !== color) list.push({from:{row:r,col:c},to:{row:nr,col:nc}}); break; }
                            nr += dr; nc += dc;
                        }
                    }
                }

                if (t === 'K') {
                    for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) {
                        if (!dr && !dc) continue;
                        const nr = r+dr, nc = c+dc;
                        if (nr >= 0 && nr < 8 && nc >= 0 && nc < 8 && this.color(this.board[nr][nc]) !== color)
                            list.push({from:{row:r,col:c},to:{row:nr,col:nc}});
                    }
                    const row = color === 'white' ? 7 : 0;
                    if (r === row && c === 4 && !this.inCheck(color)) {
                        const ks = color === 'white' ? 'K' : 'k';
                        const qs = color === 'white' ? 'Q' : 'q';
                        const opp = color === 'white' ? 'black' : 'white';
                        if (this.castling[ks] && !this.board[row][5] && !this.board[row][6] && !this.attacked(row,5,opp) && !this.attacked(row,6,opp))
                            list.push({from:{row:r,col:c},to:{row,col:6},castle:'K'});
                        if (this.castling[qs] && !this.board[row][3] && !this.board[row][2] && !this.board[row][1] && !this.attacked(row,3,opp) && !this.attacked(row,2,opp))
                            list.push({from:{row:r,col:c},to:{row,col:2},castle:'Q'});
                    }
                }
            }
        }
        return list.filter(m => { const c = this.clone(); c.make(m, true); return !c.inCheck(color); });
    }

    make(move, skip) {
        const {from, to, promo, ep, castle} = move;
        const piece = this.board[from.row][from.col];
        const cap = this.board[to.row][to.col];
        const color = this.color(piece);

        if (cap) this.captured[color].push(cap);
        if (ep) {
            const cr = color === 'white' ? to.row+1 : to.row-1;
            this.captured[color].push(this.board[cr][to.col]);
            this.board[cr][to.col] = null;
        }

        this.board[to.row][to.col] = promo ? (color === 'white' ? promo : promo.toLowerCase()) : piece;
        this.board[from.row][from.col] = null;

        if (castle) {
            const row = from.row;
            if (castle === 'K') { this.board[row][5] = this.board[row][7]; this.board[row][7] = null; }
            else { this.board[row][3] = this.board[row][0]; this.board[row][0] = null; }
        }

        if (piece.toUpperCase() === 'K') {
            if (color === 'white') { this.castling.K = false; this.castling.Q = false; }
            else { this.castling.k = false; this.castling.q = false; }
        }
        if (piece.toUpperCase() === 'R') {
            if (from.row === 7 && from.col === 7) this.castling.K = false;
            if (from.row === 7 && from.col === 0) this.castling.Q = false;
            if (from.row === 0 && from.col === 7) this.castling.k = false;
            if (from.row === 0 && from.col === 0) this.castling.q = false;
        }

        this.enPassant = (piece.toUpperCase() === 'P' && Math.abs(to.row - from.row) === 2) ? {row:(from.row+to.row)/2, col:from.col} : null;

        if (!skip) {
            const not = this.notation(move, piece, cap, castle);
            this.history.push({...move, notation:not, piece, cap, state:this.getState()});
        }

        this.turn = this.turn === 'white' ? 'black' : 'white';
        return {cap, ep, castle};
    }

    notation(m, p, cap, castle) {
        if (castle === 'K') return 'O-O';
        if (castle === 'Q') return 'O-O-O';
        const files = 'abcdefgh';
        const t = p.toUpperCase();
        let n = t !== 'P' ? t : '';
        if (cap || m.ep) { if (t === 'P') n += files[m.from.col]; n += 'x'; }
        n += files[m.to.col] + (8 - m.to.row);
        if (m.promo) n += '=' + m.promo;
        return n;
    }

    getState() { return {board:this.board.map(r=>[...r]), turn:this.turn, castling:{...this.castling}, enPassant:this.enPassant}; }

    checkmate() { return this.inCheck(this.turn) && this.moves().length === 0; }
    stalemate() { return !this.inCheck(this.turn) && this.moves().length === 0; }

    eval() {
        const vals = {P:100,N:320,B:330,R:500,Q:900,K:20000};
        let score = 0;
        for (let r = 0; r < 8; r++) for (let c = 0; c < 8; c++) {
            const p = this.board[r][c];
            if (!p) continue;
            const v = vals[p.toUpperCase()] || 0;
            score += this.isWhite(p) ? v : -v;
        }
        return score;
    }
}

// AI
class AI {
    constructor(elo = 1500) { this.setElo(elo); }

    setElo(elo) {
        this.elo = elo;
        this.lose = elo === 0;
        if (elo === 0) { this.depth = 3; this.rand = 0; }
        else if (elo <= 400) { this.depth = 1; this.rand = 400; }
        else if (elo <= 800) { this.depth = 1; this.rand = 200; }
        else if (elo <= 1200) { this.depth = 2; this.rand = 100; }
        else if (elo <= 1600) { this.depth = 3; this.rand = 50; }
        else if (elo <= 2000) { this.depth = 3; this.rand = 20; }
        else if (elo <= 2400) { this.depth = 4; this.rand = 5; }
        else { this.depth = 5; this.rand = 0; }
    }

    best(eng) {
        const moves = eng.moves();
        if (!moves.length) return null;
        if (this.elo <= 400 && this.elo > 0 && Math.random() < 0.4) return {move:moves[Math.floor(Math.random()*moves.length)],score:0};

        const scored = moves.map(m => {
            const c = eng.clone(); c.make(m, true);
            let s = this.minimax(c, this.depth-1, -Infinity, Infinity, eng.turn !== 'white');
            s += (Math.random()-0.5) * this.rand;
            return {move:m, score:s};
        });

        scored.sort((a,b) => this.lose ? (eng.turn==='white'?a.score-b.score:b.score-a.score) : (eng.turn==='white'?b.score-a.score:a.score-b.score));
        return scored[0];
    }

    minimax(e, d, a, b, max) {
        if (d === 0) return e.eval();
        const moves = e.moves();
        if (!moves.length) return e.inCheck(e.turn) ? (max ? -99999 : 99999) : 0;

        if (max) {
            let v = -Infinity;
            for (const m of moves) { const c = e.clone(); c.make(m, true); v = Math.max(v, this.minimax(c, d-1, a, b, false)); a = Math.max(a, v); if (b <= a) break; }
            return v;
        } else {
            let v = Infinity;
            for (const m of moves) { const c = e.clone(); c.make(m, true); v = Math.min(v, this.minimax(c, d-1, a, b, true)); b = Math.min(b, v); if (b <= a) break; }
            return v;
        }
    }

    analyze(eng, move, color) {
        const oldD = this.depth, oldR = this.rand, oldL = this.lose;
        this.depth = 4; this.rand = 0; this.lose = false;
        const best = this.best(eng);
        this.depth = oldD; this.rand = oldR; this.lose = oldL;

        if (!best?.move) return {cls:'book', change:0, after:0};

        const aBest = eng.clone(); aBest.make(best.move, true);
        const aActual = eng.clone(); aActual.make(move, true);
        const eBest = aBest.eval() * (color==='white'?1:-1) / 100;
        const eActual = aActual.eval() * (color==='white'?1:-1) / 100;
        const change = eActual - eBest;

        const isBest = move.from.row===best.move.from.row && move.from.col===best.move.from.col && move.to.row===best.move.to.row && move.to.col===best.move.to.col;

        let cls;
        if (isBest) cls = 'best';
        else if (change >= -0.1) cls = 'excellent';
        else if (change >= -0.3) cls = 'good';
        else if (change >= -0.7) cls = 'inaccuracy';
        else if (change >= -2) cls = 'mistake';
        else cls = 'blunder';

        const piece = eng.board[move.from.row][move.from.col];
        const vals = {P:1,N:3,B:3,R:5,Q:9,K:0};
        const pv = vals[piece?.toUpperCase()] || 0;
        const opp = color === 'white' ? 'black' : 'white';
        if (!isBest && change >= 1.5 && eng.attacked(move.to.row, move.to.col, opp)) {
            const cap = eng.board[move.to.row][move.to.col];
            if (pv > (cap ? vals[cap.toUpperCase()] : 0)) cls = 'brilliant';
        }
        if (cls === 'best' && !eng.board[move.to.row][move.to.col] && !move.castle) cls = 'great';

        return {cls, change, after:eActual, bestMove:best.move, isBest};
    }
}

// Game state
let engine = new Engine();
let ai = new AI(1500);
let selected = null;
let legal = [];
let gameOver = false;
let reviewing = false;
let reviewIdx = -1;
let analysis = [];
let dragging = false;
let dragStart = null;
let ghost = null;
let animating = false;

function init() {
    render();
    updateMoves();
    updateEval(0);

    document.getElementById('eloSlider').addEventListener('input', e => {
        const v = parseInt(e.target.value);
        ai.setElo(v);
        document.getElementById('eloVal').textContent = v;
        document.getElementById('eloDesc').textContent = Object.entries(ELO_DESC).reverse().find(([k]) => v >= parseInt(k))?.[1] || '';
        document.getElementById('botRating').textContent = `ELO ${v}`;
        let name = 'Chess Bot';
        if (v === 0) name = 'Drunk Bot üç∫';
        else if (v <= 400) name = 'Baby Bot üë∂';
        else if (v <= 800) name = 'Beginner Bot';
        else if (v <= 1200) name = 'Club Player';
        else if (v <= 1600) name = 'Intermediate';
        else if (v <= 2000) name = 'Expert';
        else if (v <= 2400) name = 'Master';
        else if (v <= 2800) name = 'Grandmaster';
        else name = 'Stockfish üêü';
        document.getElementById('botName').textContent = name;
    });

    document.addEventListener('keydown', e => {
        if (animating) return;
        if (e.key === 'ArrowLeft') goBack();
        if (e.key === 'ArrowRight') goNext();
    });
}

function render(customBoard, showClass, classIdx) {
    const board = document.getElementById('board');
    board.innerHTML = '';
    const state = customBoard || engine.board;
    const files = 'abcdefgh';

    let last = null, cls = null;
    if (reviewing && classIdx >= 0 && engine.history[classIdx]) {
        last = engine.history[classIdx];
        cls = analysis[classIdx];
    } else if (!customBoard && engine.history.length) {
        last = engine.history[engine.history.length - 1];
    }

    for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
            const sq = document.createElement('div');
            sq.className = `square ${(r+c)%2===0 ? 'light' : 'dark'}`;
            sq.dataset.row = r;
            sq.dataset.col = c;

            if (last && ((last.from.row===r && last.from.col===c) || (last.to.row===r && last.to.col===c))) sq.classList.add('last-move');
            if (selected?.row === r && selected?.col === c) sq.classList.add('selected');
            if (legal.some(m => m.to.row===r && m.to.col===c)) sq.classList.add(state[r][c] ? 'legal-capture' : 'legal-move');
            if (!customBoard && engine.inCheck(engine.turn)) {
                const k = engine.kingPos(engine.turn);
                if (k?.row===r && k?.col===c) sq.classList.add('check');
            }

            if (c === 0) sq.innerHTML += `<span class="coord rank">${8-r}</span>`;
            if (r === 7) sq.innerHTML += `<span class="coord file">${files[c]}</span>`;

            const p = state[r][c];
            if (p && !(dragging && dragStart?.row===r && dragStart?.col===c)) {
                const img = document.createElement('img');
                img.src = PIECES[p];
                img.className = 'piece';
                img.draggable = false;
                img.onmousedown = e => startDrag(e, r, c, p);
                sq.appendChild(img);
            }

            if (showClass && cls && last?.to.row===r && last?.to.col===c) {
                const icon = document.createElement('img');
                icon.src = CLASS_ICONS[cls.cls];
                icon.className = 'move-icon';
                sq.appendChild(icon);
                if (cls.cls === 'brilliant') { sq.classList.add('brilliant-square'); const pc = sq.querySelector('.piece'); if(pc) pc.classList.add('brilliant-glow'); }
                if (cls.cls === 'great') { sq.classList.add('great-square'); const pc = sq.querySelector('.piece'); if(pc) pc.classList.add('great-glow'); }
            }

            sq.onclick = () => click(r, c);
            sq.onmouseup = e => endDrag(e, r, c);
            board.appendChild(sq);
        }
    }

    updateCaptured();
    updatePlayers();
}

function startDrag(e, r, c, p) {
    if (gameOver || reviewing || engine.turn !== 'white' || !engine.isWhite(p)) return;
    e.preventDefault();
    dragging = true;
    dragStart = {row:r, col:c};
    selected = {row:r, col:c};
    legal = engine.moves().filter(m => m.from.row===r && m.from.col===c);

    ghost = document.createElement('img');
    ghost.src = PIECES[p];
    ghost.className = 'ghost-piece';
    document.body.appendChild(ghost);
    moveGhost(e);
    render();

    document.addEventListener('mousemove', moveGhost);
    document.addEventListener('mouseup', dropGhost);
}

function moveGhost(e) { if (ghost) { ghost.style.left = e.clientX + 'px'; ghost.style.top = e.clientY + 'px'; } }

function dropGhost() {
    document.removeEventListener('mousemove', moveGhost);
    document.removeEventListener('mouseup', dropGhost);
    if (ghost) { ghost.remove(); ghost = null; }
    dragging = false;
    dragStart = null;
}

function endDrag(e, r, c) {
    if (!dragging) return;
    const move = legal.find(m => m.to.row===r && m.to.col===c);
    if (move) {
        if (move.promo) { showPromo(move); return; }
        makeMove(move);
    }
    selected = null;
    legal = [];
    dragging = false;
    dragStart = null;
    if (ghost) { ghost.remove(); ghost = null; }
    render();
}

function click(r, c) {
    if (gameOver || reviewing || dragging || engine.turn !== 'white') return;
    const move = legal.find(m => m.to.row===r && m.to.col===c);
    if (move) {
        if (move.promo) { showPromo(move); return; }
        makeMove(move);
        return;
    }
    const p = engine.board[r][c];
    if (p && engine.isWhite(p)) {
        selected = {row:r, col:c};
        legal = engine.moves().filter(m => m.from.row===r && m.from.col===c);
    } else {
        selected = null;
        legal = [];
    }
    render();
}

function showPromo(move) {
    const modal = document.getElementById('promoModal');
    const cont = document.getElementById('promoPieces');
    cont.innerHTML = '';
    ['Q','R','B','N'].forEach(pr => {
        const div = document.createElement('div');
        div.className = 'promo-piece';
        div.innerHTML = `<img src="${PIECES[pr]}">`;
        div.onclick = () => {
            modal.classList.remove('active');
            selected = null;
            legal = [];
            makeMove({...move, promo:pr});
        };
        cont.appendChild(div);
    });
    modal.classList.add('active');
}

function makeMove(move) {
    const cap = engine.board[move.to.row][move.to.col];
    const res = engine.make(move);
    selected = null;
    legal = [];
    render();

    const sq = document.querySelector(`.square[data-row="${move.to.row}"][data-col="${move.to.col}"]`);
    if (cap) { sound('capture'); } else { sound('move'); }

    updateMoves();
    updateEval(engine.eval() / 100);

    if (engine.inCheck(engine.turn)) {
        sound('check');
        document.querySelector('.board-wrapper').style.animation = 'shake 0.4s';
        setTimeout(() => document.querySelector('.board-wrapper').style.animation = '', 400);
    }

    if (checkEnd()) return;
    setTimeout(aiMove, 400);
}

function aiMove() {
    if (gameOver) return;
    document.getElementById('thinking').classList.add('show');

    setTimeout(() => {
        const res = ai.best(engine);
        document.getElementById('thinking').classList.remove('show');
        if (res?.move) {
            const cap = engine.board[res.move.to.row][res.move.to.col];
            engine.make(res.move);
            render();
            if (cap) sound('capture'); else sound('move');
            updateMoves();
            updateEval(engine.eval() / 100);
            if (engine.inCheck(engine.turn)) {
                sound('check');
                document.querySelector('.board-wrapper').style.animation = 'shake 0.4s';
                setTimeout(() => document.querySelector('.board-wrapper').style.animation = '', 400);
            }
            checkEnd();
        }
    }, 300 + Math.random() * 500);
}

function checkEnd() {
    if (engine.checkmate()) {
        gameOver = true;
        const won = engine.turn === 'black';
        const k = engine.kingPos(engine.turn);
        setTimeout(() => checkmateAnim(k, won), 100);
        setTimeout(() => {
            document.getElementById('modalIcon').textContent = won ? 'üëë' : 'üíÄ';
            document.getElementById('modalTitle').textContent = won ? 'Victory!' : 'Defeat';
            document.getElementById('modalMsg').textContent = won ? 'Checkmate!' : 'You were checkmated';
            document.getElementById('status').textContent = won ? 'üéâ Victory!' : 'üò¢ Defeated';
            document.getElementById('status').className = 'game-status ' + (won ? 'win' : 'loss');
            document.getElementById('statMoves').textContent = Math.ceil(engine.history.length / 2);
            document.getElementById('gameOverModal').classList.add('active');
        }, 1500);
        return true;
    }
    if (engine.stalemate()) {
        gameOver = true;
        document.getElementById('modalIcon').textContent = 'ü§ù';
        document.getElementById('modalTitle').textContent = 'Draw';
        document.getElementById('modalMsg').textContent = 'Stalemate';
        document.getElementById('status').textContent = 'Draw';
        document.getElementById('status').className = 'game-status';
        document.getElementById('gameOverModal').classList.add('active');
        return true;
    }
    return false;
}

function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); }

function newGame() {
    engine = new Engine();
    gameOver = false;
    reviewing = false;
    selected = null;
    legal = [];
    analysis = [];
    reviewIdx = -1;
    closeModals();
    render();
    updateMoves();
    updateEval(0);
    document.getElementById('status').textContent = '';
    document.getElementById('status').className = 'game-status';
    showTab('moves');
    document.getElementById('playTab').classList.add('active');
    document.getElementById('reviewTab').classList.remove('active');
}

function resignGame() {
    if (gameOver || !engine.history.length) return;
    gameOver = true;
    sound('defeat');
    document.getElementById('modalIcon').textContent = 'üè≥Ô∏è';
    document.getElementById('modalTitle').textContent = 'Resigned';
    document.getElementById('modalMsg').textContent = 'You resigned';
    document.getElementById('status').textContent = 'Resigned';
    document.getElementById('status').className = 'game-status loss';
    document.getElementById('gameOverModal').classList.add('active');
}

function updateMoves() {
    const panel = document.getElementById('movesPanel');
    const moves = engine.history;
    if (!moves.length) {
        panel.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ôü</div><div class="empty-state-text">Your move</div></div>';
        return;
    }
    panel.innerHTML = '';
    for (let i = 0; i < moves.length; i += 2) {
        const row = document.createElement('div');
        row.className = 'move-row';

        const num = document.createElement('span');
        num.className = 'move-num';
        num.textContent = (i/2+1) + '.';
        row.appendChild(num);

        const w = document.createElement('span');
        w.className = 'move' + (reviewing && reviewIdx === i ? ' current' : '');
        if (analysis[i]) w.innerHTML = `<img src="${CLASS_ICONS[analysis[i].cls]}">`;
        w.innerHTML += moves[i].notation;
        w.onclick = () => goTo(i);
        row.appendChild(w);

        if (moves[i+1]) {
            const b = document.createElement('span');
            b.className = 'move' + (reviewing && reviewIdx === i+1 ? ' current' : '');
            if (analysis[i+1]) b.innerHTML = `<img src="${CLASS_ICONS[analysis[i+1].cls]}">`;
            b.innerHTML += moves[i+1].notation;
            b.onclick = () => goTo(i+1);
            row.appendChild(b);
        }
        panel.appendChild(row);
    }
    panel.scrollTop = panel.scrollHeight;
}

function updateEval(ev) {
    const fill = document.getElementById('evalFill');
    const top = document.getElementById('evalTop');
    const bot = document.getElementById('evalBot');
    const clamped = Math.max(-10, Math.min(10, ev));
    fill.style.height = (50 + clamped * 5) + '%';
    if (ev > 0) { bot.textContent = '+' + ev.toFixed(1); top.textContent = ''; }
    else if (ev < 0) { top.textContent = Math.abs(ev).toFixed(1); bot.textContent = ''; }
    else { bot.textContent = '0.0'; top.textContent = ''; }
}

function updateCaptured() {
    const vals = {P:1,N:3,B:3,R:5,Q:9,p:1,n:3,b:3,r:5,q:9};
    let wMat = 0, bMat = 0;
    engine.captured.white.forEach(p => wMat += vals[p] || 0);
    engine.captured.black.forEach(p => bMat += vals[p] || 0);
    const diff = wMat - bMat;

    document.getElementById('capWhite').innerHTML = engine.captured.white.map(p => `<img src="${PIECES[p]}" class="captured-piece">`).join('') + (diff > 0 ? `<span class="material-diff">+${diff}</span>` : '');
    document.getElementById('capBlack').innerHTML = engine.captured.black.map(p => `<img src="${PIECES[p]}" class="captured-piece">`).join('') + (diff < 0 ? `<span class="material-diff">+${-diff}</span>` : '');
}

function updatePlayers() {
    document.getElementById('whiteBar').classList.toggle('active', engine.turn === 'white' && !gameOver);
    document.getElementById('blackBar').classList.toggle('active', engine.turn === 'black' && !gameOver);
    document.getElementById('whiteClock').classList.toggle('active', engine.turn === 'white' && !gameOver);
    document.getElementById('blackClock').classList.toggle('active', engine.turn === 'black' && !gameOver);
}

function showPlay() {
    document.getElementById('playTab').classList.add('active');
    document.getElementById('reviewTab').classList.remove('active');
    reviewing = false;
    reviewIdx = -1;
    render();
    updateMoves();
}

function showTab(tab) {
    document.querySelectorAll('.tabs .tab').forEach((t, i) => t.classList.toggle('active', (tab === 'moves' && i === 0) || (tab === 'analysis' && i === 1)));
    document.getElementById('movesPanel').style.display = tab === 'moves' ? 'block' : 'none';
    document.getElementById('reviewPanel').style.display = tab === 'analysis' ? 'block' : 'none';
    document.getElementById('reviewPanel').classList.toggle('active', tab === 'analysis');
}

function startReview() {
    if (!engine.history.length) { alert('Play a game first!'); return; }
    document.getElementById('playTab').classList.remove('active');
    document.getElementById('reviewTab').classList.add('active');
    showTab('analysis');

    document.getElementById('reviewPanel').innerHTML = `<div class="analyzing"><div class="spinner"></div><div class="analyzing-text">Analyzing...</div><div class="analyzing-sub">Finding brilliancies</div><div class="progress-bar"><div class="progress-fill" id="progFill"></div></div></div>`;

    setTimeout(runAnalysis, 100);
}

function runAnalysis() {
    analysis = [];
    const temp = new Engine();
    const analyzer = new AI(2800);
    const total = engine.history.length;
    let i = 0;

    function next() {
        if (i >= total) {
            showResults();
            reviewing = true;
            reviewIdx = -1;
            updateMoves();
            return;
        }
        const move = engine.history[i];
        const color = i % 2 === 0 ? 'white' : 'black';
        analysis.push(analyzer.analyze(temp, move, color));
        temp.make(move, true);
        const prog = document.getElementById('progFill');
        if (prog) prog.style.width = ((i+1)/total*100) + '%';
        i++;
        setTimeout(next, 20);
    }
    next();
}

function showResults() {
    const panel = document.getElementById('reviewPanel');
    const wA = analysis.filter((_, i) => i % 2 === 0);
    const bA = analysis.filter((_, i) => i % 2 === 1);

    const acc = arr => {
        if (!arr.length) return 100;
        return Math.round(arr.reduce((s, a) => s + ({brilliant:100,great:100,best:100,excellent:95,good:85,inaccuracy:50,mistake:25,blunder:0}[a.cls] || 80), 0) / arr.length);
    };
    const wAcc = acc(wA), bAcc = acc(bA);
    const cnt = (arr, c) => arr.filter(a => a.cls === c).length;
    const circ = 2 * Math.PI * 38;

    document.getElementById('statAcc').textContent = wAcc + '%';

    const classes = ['brilliant','great','best','excellent','good','inaccuracy','mistake','blunder'];
    const names = {brilliant:'Brilliant',great:'Great',best:'Best',excellent:'Excellent',good:'Good',inaccuracy:'Inaccuracy',mistake:'Mistake',blunder:'Blunder'};

    panel.innerHTML = `
        <div class="accuracy-section">
            <div class="accuracy-item">
                <div class="accuracy-ring white">
                    <svg viewBox="0 0 100 100"><circle class="bg" cx="50" cy="50" r="38"/><circle class="prog" cx="50" cy="50" r="38" stroke-dasharray="${circ}" stroke-dashoffset="${circ*(1-wAcc/100)}"/></svg>
                    <div class="accuracy-val">${wAcc}%</div>
                </div>
                <div class="accuracy-label">You</div>
            </div>
            <div class="accuracy-item">
                <div class="accuracy-ring black">
                    <svg viewBox="0 0 100 100"><circle class="bg" cx="50" cy="50" r="38"/><circle class="prog" cx="50" cy="50" r="38" stroke-dasharray="${circ}" stroke-dashoffset="${circ*(1-bAcc/100)}"/></svg>
                    <div class="accuracy-val">${bAcc}%</div>
                </div>
                <div class="accuracy-label">Bot</div>
            </div>
        </div>
        ${classes.map(c => `
            <div class="class-row">
                <div class="class-label"><img src="${CLASS_ICONS[c]}"><span>${names[c]}</span></div>
                <div class="class-counts">
                    <span class="class-count ${cnt(wA,c)?'has':''}">${cnt(wA,c)}</span>
                    <span class="class-count ${cnt(bA,c)?'has':''}">${cnt(bA,c)}</span>
                </div>
            </div>
        `).join('')}
        <div id="reviewBox"></div>
    `;
}

function goTo(idx) {
    if (animating || idx < -1 || idx >= engine.history.length) return;
    
    const prevIdx = reviewIdx;
    reviewIdx = idx;

    if (idx === -1) {
        render(new Engine().board, false, -1);
        updateEval(0);
        updateMoves();
        return;
    }

    // Animate piece movement
    if (reviewing && prevIdx >= -1 && idx > prevIdx) {
        animateMoves(prevIdx, idx);
    } else {
        const state = engine.history[idx].state;
        render(state.board, true, idx);
        if (analysis[idx]) {
            updateEval(analysis[idx].after);
            showMoveInfo(idx);
            // Trigger effects for brilliant/great
            if (analysis[idx].cls === 'brilliant') {
                setTimeout(() => {
                    const sq = document.querySelector(`.square[data-row="${engine.history[idx].to.row}"][data-col="${engine.history[idx].to.col}"]`);
                    if (sq) brilliantEffect(sq);
                }, 100);
            } else if (analysis[idx].cls === 'great') {
                setTimeout(() => {
                    const sq = document.querySelector(`.square[data-row="${engine.history[idx].to.row}"][data-col="${engine.history[idx].to.col}"]`);
                    if (sq) greatEffect(sq);
                }, 100);
            }
        }
        updateMoves();
    }
}

function animateMoves(fromIdx, toIdx) {
    animating = true;
    let current = fromIdx;

    function animateNext() {
        current++;
        if (current > toIdx) {
            animating = false;
            return;
        }

        const move = engine.history[current];
        const prevState = current === 0 ? new Engine().board : engine.history[current-1].state.board;
        const nextState = move.state.board;
        const cls = analysis[current]?.cls;

        // Render previous state first
        render(prevState, false, current - 1);

        // Create animated piece
        const board = document.getElementById('board');
        const piece = prevState[move.from.row][move.from.col];
        if (!piece) { animateNext(); return; }

        const anim = document.createElement('img');
        anim.src = PIECES[piece];
        anim.className = 'anim-piece' + (cls === 'brilliant' ? ' brilliant' : cls === 'great' ? ' great' : '');
        anim.style.left = (move.from.col * 80 + 4) + 'px';
        anim.style.top = (move.from.row * 80 + 4) + 'px';
        board.appendChild(anim);

        // Hide piece at from square
        const fromSq = document.querySelector(`.square[data-row="${move.from.row}"][data-col="${move.from.col}"] .piece`);
        if (fromSq) fromSq.style.opacity = '0';

        requestAnimationFrame(() => {
            anim.style.left = (move.to.col * 80 + 4) + 'px';
            anim.style.top = (move.to.row * 80 + 4) + 'px';
        });

        setTimeout(() => {
            anim.remove();
            render(nextState, true, current);
            if (analysis[current]) {
                updateEval(analysis[current].after);
                showMoveInfo(current);

                // Effects
                if (cls === 'brilliant') {
                    const sq = document.querySelector(`.square[data-row="${move.to.row}"][data-col="${move.to.col}"]`);
                    if (sq) brilliantEffect(sq);
                } else if (cls === 'great') {
                    const sq = document.querySelector(`.square[data-row="${move.to.row}"][data-col="${move.to.col}"]`);
                    if (sq) greatEffect(sq);
                }
            }
            updateMoves();

            setTimeout(animateNext, cls === 'brilliant' ? 1500 : cls === 'great' ? 1000 : 300);
        }, 500);
    }

    animateNext();
}

function showMoveInfo(idx) {
    const box = document.getElementById('reviewBox');
    if (!box || !analysis[idx]) return;
    const a = analysis[idx];
    const m = engine.history[idx];
    const names = {brilliant:'Brilliant',great:'Great',best:'Best',excellent:'Excellent',good:'Good',inaccuracy:'Inaccuracy',mistake:'Mistake',blunder:'Blunder'};
    const files = 'abcdefgh';

    box.innerHTML = `
        <div class="review-move-box">
            <div class="review-move-header">
                <div class="review-move-info">
                    <img src="${CLASS_ICONS[a.cls]}">
                    <span class="review-move-notation">${m.notation}</span>
                    <span class="review-move-type">${names[a.cls]}</span>
                </div>
                <span class="eval-badge ${a.change >= 0 ? 'pos' : 'neg'}">${a.change >= 0 ? '+' : ''}${a.change.toFixed(2)}</span>
            </div>
            ${!a.isBest && a.bestMove ? `<div class="review-best">Best: <strong>${files[a.bestMove.from.col]}${8-a.bestMove.from.row}${files[a.bestMove.to.col]}${8-a.bestMove.to.row}</strong></div>` : ''}
        </div>
    `;
}

function goStart() { goTo(-1); }
function goBack() { goTo(Math.max(-1, reviewIdx - 1)); }
function goNext() { goTo(Math.min(engine.history.length - 1, reviewIdx + 1)); }
function goEnd() { goTo(engine.history.length - 1); }

init();
</script>
</body>
</html>
